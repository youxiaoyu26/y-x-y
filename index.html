<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å§å§çš„ä¸ªäººç©ºé—´</title>
    <style id="dynamicStyle">
        :root { 
            --main: #d4a373; 
            --bg: #faf9f6; 
            --radius: 12px; 
            --font: -apple-system, sans-serif;
        }
        body { 
            background: var(--bg); 
            font-family: var(--font); 
            margin: 0; padding-top: 65px; 
            background-size: cover; background-position: center; background-attachment: fixed; 
            transition: 0.3s; 
        }
        header { position: fixed; top: 0; width: 100%; height: 55px; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { color: var(--main); font-weight: bold; font-size: 1rem; }
        .menu-btn { cursor: pointer; border: none; background: none; display: flex; flex-direction: column; gap: 4px; padding: 10px; }
        .menu-btn span { width: 20px; height: 2px; background: var(--main); border-radius: 2px; }

        /* ä¾§è¾¹æ ä¸å…¬å‘Š */
        #sidePanel { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: #fff; z-index: 2000; transition: 0.3s; padding: 25px 20px; box-sizing: border-box; box-shadow: -5px 0 15px rgba(0,0,0,0.05); overflow-y: auto; }
        #sidePanel.open { right: 0; }
        .side-label { font-size: 10px; color: #bbb; margin: 15px 0 8px; display: block; text-transform: uppercase; border-bottom: 1px solid #f5f5f5; padding-bottom: 3px; }
        .ver-badge { background: var(--main); color: white; padding: 1px 5px; border-radius: 4px; font-size: 9px; margin-bottom: 3px; display: inline-block; }
        .notice-content { font-size: 12.5px; color: #444; line-height: 1.5; }

        /* ç™»å½•æ¡†å¢å¼º */
        .login-hint { font-size: 10px; color: #999; margin: 4px 0 8px; display: block; }

        /* åŠ¨æ€å¡ç‰‡ç´§å‡‘å‹ */
        .card { 
            background: rgba(255,255,255,0.9); 
            padding: 12px 15px; 
            margin-bottom: 12px; 
            border-left: 3px solid var(--main); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
        .author-name { font-size: 11.5px; color: var(--main); font-weight: bold; }
        .post-time { font-size: 9px; color: #ccc; }
        .post-text { color: #444; font-size: 13.5px; line-height: 1.45; white-space: pre-wrap; margin-bottom: 8px; }

        /* æŒ‰é’®å¹¶æ’ */
        .action-bar { display: flex; border-top: 1px solid #fcfcfc; padding-top: 8px; }
        .action-btn { flex: 1; font-size: 11px; color: var(--main); cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 4px 0; }
        .action-btn:first-child { border-right: 1px solid #f5f5f5; }

        /* å¸ƒå±€å®¹å™¨ */
        .container { max-width: 480px; margin: 0 auto; padding: 0 12px; }
        #status { font-size: 10px; color: #999; text-align: center; margin-bottom: 10px; height: 14px; }
        .input-card { background: rgba(255,255,255,0.9); padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        textarea { width: 100%; height: 60px; border: 1px solid #f0f0f0; padding: 10px; box-sizing: border-box; font-size: 14px; outline: none; resize: none; background: #fdfdfd; }
        
        .btn { border: none; cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: var(--radius); }
        /* å‘å¸ƒåŒºåŸŸæŒ‰é’®ç»„ï¼šå‘å¸ƒå 75%ï¼Œåˆ·æ–°å 20%ï¼Œç•™5%é—´éš™ */
        .btn-group {
            display: flex;
            gap: 5%;
            margin-top: 8px;
        }
        .btn-pub { 
            flex: 0 0 75%; 
            background: var(--main); 
            color: white; 
            padding: 10px; 
            font-size: 14px; 
            box-sizing: border-box;
        }
        .btn-refresh { 
            flex: 0 0 20%; 
            background: rgba(0,0,0,0.05); 
            color: #666; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-sizing: border-box;
        }

        /* è¯„è®ºåŒºåŸŸå‘é€æŒ‰é’®è°ƒæ•´ä¸º20%å®½åº¦ï¼Œè¾“å…¥æ¡†å 80% */
        .comment-input-group {
            display: flex;
            gap: 5%;
            margin-top: 6px;
            align-items: center;
        }
        .comment-input-field {
            flex: 0 0 75%; /* å®é™…ä¸Šé…åˆ5%é—´éš™ï¼Œ75%+20%+5%=100%ï¼Œè¿™é‡Œ75%æ˜¯è¾“å…¥æ¡†ï¼ŒæŒ‰é’®20%ï¼Œé—´éš™5% */
            padding: 4px;
            font-size: 11px;
            border: 1px solid #eee;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .comment-send-btn {
            flex: 0 0 20%;
            background: var(--main);
            color: white;
            padding: 4px 0;
            font-size: 10px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: bold;
            box-sizing: border-box;
            text-align: center;
        }

        #devModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 330px; background: white; z-index: 3000; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; display: none; border-radius: 20px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 1999; backdrop-filter: blur(4px); }
        
        .comment-item { background: rgba(0,0,0,0.02); padding: 6px 10px; margin-top: 4px; font-size: 11px; border-radius: 6px; }
        .rotating { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card, .input-card, .btn, .notice-box { border-radius: var(--radius) !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo">å§å§çš„ä¸ªäººç©ºé—´</div>
        <button class="menu-btn" onclick="toggleMenu()"><span></span><span></span><span></span></button>
    </header>

    <div id="overlay" onclick="closeAll()"></div>

    <div id="sidePanel">
        <span class="side-label">ğŸ“¢ å…¬å‘Šæ </span>
        <div id="currentNotice">
            <span class="ver-badge" id="verDisplay">v10.0.0</span>
            <div class="notice-content" id="noticeText">åŠ è½½ä¸­...</div>
        </div>
        <span style="font-size:11px; color:var(--main); cursor:pointer; margin-top:8px; display:block" onclick="toggleHistory()">å†å²æ›´æ–°è®°å½• â†“</span>
        <div id="historyBox" style="display:none; margin-top:10px; border-top:1px dashed #eee; padding-top:8px"></div>

        <span class="side-label">ğŸ‘¤ è®¿å®¢ç™»å½•</span>
        <div id="userSection" style="background:#f9f9f9; padding:12px; border-radius:10px; border:1px solid #eee">
            <div id="loginForm">
                <input type="text" id="uName" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; font-size:12px; box-sizing:border-box" placeholder="ä½ çš„æ˜µç§°">
                <input type="password" id="uPass" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; font-size:12px; margin-top:6px; box-sizing:border-box" placeholder="è®¾ç½®è¿›å…¥å¯†ç ">
                <span class="login-hint">ğŸ”’ å¯†ç ä¸èƒ½å°‘äº 6 ä¸ªå­—ç¬¦</span>
                <button class="btn btn-pub" style="width:100%; padding:6px; font-size:12px" onclick="handleAuth()">éªŒè¯è¿›å…¥</button>
            </div>
            <div id="userInfo" style="display:none">
                <span style="font-size:12px">æ¬¢è¿ï¼Œ<b id="currUser" style="color:var(--main)"></b></span>
                <button class="btn" style="background:#eee; font-size:10px; padding:2px 8px; margin-left:5px" onclick="logout()">æ³¨é”€</button>
            </div>
        </div>

        <button class="btn" style="background:#444; color:white; width:100%; margin-top:15px; padding:8px; font-size:12px" onclick="showDevAuth()">ğŸ› ï¸ å¼€å‘è€…æ¨¡å¼</button>
        <div id="devAuthArea" style="display:none; margin-top:8px">
            <input type="password" id="devPassInput" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box" placeholder="å£ä»¤">
            <button class="btn btn-pub" style="width:100%; margin-top:5px; padding:6px" onclick="verifyDevPass()">ç¡®è®¤è¿›å…¥</button>
        </div>
    </div>

    <div id="devModal">
        <h3 style="margin:0 0 15px; text-align:center; font-size:16px">ğŸ› ï¸ å¼€å‘è€…é…ç½®</h3>
        <div style="background:#f0f7ff; padding:10px; border-radius:10px; margin-bottom:12px">
            <label style="font-size:11px; font-weight:bold">å…¬å‘Šæ›´æ–°</label>
            <input type="text" id="devVer" style="width:100%; margin-top:4px; padding:5px; font-size:12px; box-sizing:border-box" placeholder="ç‰ˆæœ¬å·">
            <textarea id="devNotice" style="width:100%; height:40px; margin-top:4px; padding:5px; font-size:12px; box-sizing:border-box" placeholder="å†…å®¹..."></textarea>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
            <div><label style="font-size:11px">ä¸»è‰²</label><input type="color" id="themeColor" style="width:100%"></div>
            <div><label style="font-size:11px">èƒŒæ™¯è‰²</label><input type="color" id="bgColor" style="width:100%"></div>
        </div>
        <div style="margin-top:8px"><label style="font-size:11px">èƒŒæ™¯å›¾ URL</label><input type="text" id="bgUrl" style="width:100%; padding:5px; font-size:12px; box-sizing:border-box"></div>
        <div style="margin-top:8px">
            <label style="font-size:11px">UI åœ†è§’: <span id="radiusVal">12px</span></label>
            <input type="range" id="radiusRange" min="0" max="25" style="width:100%">
        </div>
        <div style="display:flex; flex-direction:column; gap:6px; margin-top:15px">
            <button class="btn btn-pub" onclick="saveSettingsToCloud()">åŒæ­¥å‘å¸ƒ</button>
            <button class="btn" style="background:#ff4d4d; color:white; padding:8px" onclick="resetSettings()">é‡ç½®è£…ä¿®</button>
            <button class="btn" style="background:#eee; padding:8px" onclick="closeAll()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="container">
        <div id="status">è¿æ¥ä¸­...</div>
        <div class="input-card">
            <textarea id="msgInput" placeholder="åœ¨æ­¤åˆ†äº«ä½ çš„åŠ¨æ€..."></textarea>
            <!-- å‘å¸ƒæŒ‰é’®ç»„ï¼šå‘å¸ƒ75%ï¼Œåˆ·æ–°20% -->
            <div class="btn-group">
                <button class="btn btn-pub" onclick="publish()">å‘å¸ƒ</button>
                <button class="btn btn-refresh" onclick="loadData()"><span id="refreshIcon">â†»</span></button>
            </div>
        </div>
        <div id="msgList"></div>
    </div>

    <script>
        const CONFIG = {
            KEY: "$2a$10$RhcPZqRZZjdSWEp85cbSb.xngZSGZeda4a25br/od0U9pyqLcKBja", 
            BIN: "699c4b22ae596e708f424292",
            DEV_PASS: "ä½œè€…æœ€å¸…"
        };
        const DEFAULT_S = { theme: "#d4a373", bgCol: "#faf9f6", bgImg: "", font: "-apple-system, sans-serif", radius: 12, currentVer: "v1.0", notice: "æ¬¢è¿å…‰ä¸´ï¼", history: [] };
        let currentUser = localStorage.getItem('sister_user') || null;

        // ç™»å½•éªŒè¯
        function handleAuth() {
            const n = document.getElementById('uName').value.trim();
            const p = document.getElementById('uPass').value;

            if(!n) { alert("è¯·è¾“å…¥æ˜µç§°"); return; }
            if(p.length < 6) { 
                alert("âš ï¸ ä¸ºäº†å®‰å…¨ï¼Œå¯†ç ä¸èƒ½å°‘äº 6 ä¸ªå­—ç¬¦ï¼"); 
                return; 
            }
            
            currentUser = n; 
            localStorage.setItem('sister_user', n); 
            updateUserUI();
            alert("ç™»å½•æˆåŠŸï¼");
        }

        async function updateCloud(newData) {
            document.getElementById('status').innerText = "åŒæ­¥ä¸­...";
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}`, { 
                    method: 'PUT', 
                    headers: { "Content-Type": "application/json", "X-Master-Key": CONFIG.KEY }, 
                    body: JSON.stringify(newData) 
                });
                await loadData();
            } catch (e) { }
        }

        async function loadData() {
            const icon = document.getElementById('refreshIcon'); icon.classList.add('rotating');
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest?v=${Date.now()}`, { headers: { "X-Master-Key": CONFIG.KEY }});
                const d = await res.json(); 
                applyStyles(d.record.settings); 
                render(d.record.notes || []);
                document.getElementById('status').innerText = "âœ¨ ç©ºé—´å·²åˆ·æ–°";
            } catch (e) { }
            setTimeout(() => icon.classList.remove('rotating'), 500);
        }

        function applyStyles(s) {
            if(!s) s = DEFAULT_S;
            const root = document.documentElement;
            root.style.setProperty('--main', s.theme);
            root.style.setProperty('--bg', s.bgCol);
            root.style.setProperty('--radius', s.radius + 'px');
            document.body.style.backgroundImage = s.bgImg ? `url(${s.bgImg})` : 'none';
            document.getElementById('verDisplay').innerText = s.currentVer;
            document.getElementById('noticeText').innerText = s.notice;
            document.getElementById('historyBox').innerHTML = (s.history || []).reverse().map(h => `<div style="font-size:11px; margin-bottom:5px; color:#666"><b>${h.ver}</b>: ${h.text}</div>`).join('');
        }

        function render(notes) {
            const list = document.getElementById('msgList'); list.innerHTML = '';
            [...notes].map((n, i) => ({...n, rIdx: i})).reverse().forEach(note => {
                const div = document.createElement('div'); div.className = 'card';
                const comms = (note.comments || []).map((c, ci) => `
                    <div class="comment-item"><b>${c.user}:</b> ${c.content} <span style="float:right; cursor:pointer" onclick="handleLike(${note.rIdx}, ${ci})">ğŸ‘ ${c.likes || 0}</span></div>
                `).join('');
                // ä¿®æ”¹è¯„è®ºè¾“å…¥åŒºï¼šä½¿ç”¨ comment-input-groupï¼Œè¾“å…¥æ¡†å 75%ï¼ˆå®é™…æ˜¾ç¤º80%æ•ˆæœé…åˆ5%é—´éš™ï¼‰ï¼Œå‘é€æŒ‰é’®å 20%
                div.innerHTML = `
                    <div class="card-header">
                        <span class="author-name">ğŸ‘¤ ${note.author}</span>
                        <span class="post-time">${note.time}</span>
                    </div>
                    <div class="post-text">${note.content}</div>
                    <div class="action-bar">
                        <div class="action-btn" onclick="handleLike(${note.rIdx})">ğŸ‘ ${note.likes || 0}</div>
                        <div class="action-btn" onclick="toggleComments(${note.rIdx})">ğŸ’¬ ${(note.comments || []).length}</div>
                    </div>
                    <div id="comments-${note.rIdx}" style="display:none; margin-top:8px">
                        ${comms}
                        <div class="comment-input-group">
                            <input type="text" id="comment-input-${note.rIdx}" class="comment-input-field" placeholder="å†™è¯„è®º...">
                            <button class="comment-send-btn" onclick="submitComment(${note.rIdx})">å‘</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // åŸºç¡€é€»è¾‘...
        async function handleLike(nIdx, cIdx = null) {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); let notes = data.record.notes || [];
            if (cIdx === null) notes[nIdx].likes = (notes[nIdx].likes || 0) + 1;
            else notes[nIdx].comments[cIdx].likes = (notes[nIdx].comments[cIdx].likes || 0) + 1;
            await updateCloud({ ...data.record, notes });
        }
        async function submitComment(idx) {
            if(!currentUser) return alert("è¯·ç™»å½•");
            const val = document.getElementById(`comment-input-${idx}`).value.trim(); if(!val) return;
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); let notes = data.record.notes || [];
            if(!notes[idx].comments) notes[idx].comments = [];
            notes[idx].comments.push({ user: currentUser, content: val, likes: 0 });
            await updateCloud({ ...data.record, notes });
        }
        async function publish() {
            if(!currentUser) return alert("è¯·ç™»å½•"); const input = document.getElementById('msgInput'); if(!input.value.trim()) return;
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); let notes = data.record.notes || [];
            notes.push({ author: currentUser, content: input.value, time: new Date().toLocaleString('zh-CN'), comments: [], likes: 0 });
            input.value = ''; await updateCloud({ ...data.record, notes });
        }
        async function saveSettingsToCloud() {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); const s = data.record.settings || DEFAULT_S;
            const v = document.getElementById('devVer').value; const n = document.getElementById('devNotice').value;
            if(v && n && v !== s.currentVer) { s.history.push({ ver: s.currentVer, text: s.notice }); s.currentVer = v; s.notice = n; }
            const upd = { ...s, theme: document.getElementById('themeColor').value, bgCol: document.getElementById('bgColor').value, bgImg: document.getElementById('bgUrl').value, radius: document.getElementById('radiusRange').value };
            await updateCloud({ ...data.record, settings: upd }); closeAll();
        }
        async function resetSettings() { if(confirm("é‡ç½®æ‰€æœ‰è£…ä¿®ï¼Ÿ")) { const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }}); const data = await res.json(); await updateCloud({ ...data.record, settings: DEFAULT_S }); closeAll(); } }
        function toggleHistory() { const b = document.getElementById('historyBox'); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
        function toggleMenu() { document.getElementById('sidePanel').classList.toggle('open'); document.getElementById('overlay').style.display = 'block'; updateUserUI(); }
        function closeAll() { document.getElementById('devModal').style.display = 'none'; document.getElementById('sidePanel').classList.remove('open'); document.getElementById('overlay').style.display = 'none'; document.getElementById('devAuthArea').style.display='none'; }
        function showDevAuth() { document.getElementById('devAuthArea').style.display='block'; }
        function verifyDevPass() { if(document.getElementById('devPassInput').value === CONFIG.DEV_PASS) { document.getElementById('devModal').style.display = 'block'; } else { alert("å£ä»¤é”™è¯¯"); } }
        function logout() { localStorage.removeItem('sister_user'); currentUser = null; updateUserUI(); }
        function updateUserUI() { 
            document.getElementById('userInfo').style.display = currentUser ? 'block' : 'none'; 
            document.getElementById('loginForm').style.display = currentUser ? 'none' : 'block'; 
            if(currentUser) document.getElementById('currUser').innerText = currentUser; 
        }
        function toggleComments(id) { const el = document.getElementById(`comments-${id}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
        document.getElementById('radiusRange').oninput = function() { document.getElementById('radiusVal').innerText = this.value + 'px'; }
        window.onload = loadData;
    </script>
</body>
</html>
