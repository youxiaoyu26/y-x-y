<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- è§†å£è®¾ç½®ï¼šç¦æ­¢ç¼©æ”¾ï¼Œå›ºå®šåˆå§‹æ¯”ä¾‹ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>å§å§çš„ä¸ªäººç©ºé—´</title>
    <style id="dynamicStyle">
        :root { 
            --main: #F2A674; 
            --bg: #EBEBEB; 
            --radius: 12px; 
            --font: -apple-system, sans-serif;
            --effect-color: #F2A674;
            --effect-size: 30px;
            --effect-shape: circle;
        }
        body { 
            background: var(--bg); 
            font-family: var(--font); 
            margin: 0; padding-top: 65px; 
            background-size: cover; background-position: center; background-attachment: fixed; 
            transition: 0.3s; 
            position: relative;
            min-height: 100vh;
        }
        /* ç‚¹å‡»ç‰¹æ•ˆç”»å¸ƒ */
        #clickCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        header { position: fixed; top: 0; width: 100%; height: 55px; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { color: var(--main); font-weight: bold; font-size: 1rem; cursor: pointer; }  /* æ·»åŠ æŒ‡é’ˆä¾¿äºç‚¹å‡»è¿”å› */
        /* å¤´éƒ¨å³ä¾§ç»„ï¼šå·¥å…·æŒ‰é’® + èœå•æŒ‰é’® */
        .header-right-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* å·¥å…·æŒ‰é’®æ ·å¼ - ä»…ç™»å½•å¯è§ */
        .tool-btn {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--main);
            padding: 0 5px;
            display: none;  /* é»˜è®¤éšè—ï¼Œç™»å½•åæ˜¾ç¤º */
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: opacity 0.2s;
        }
        .tool-btn:hover {
            opacity: 0.8;
        }
        .menu-btn { cursor: pointer; border: none; background: none; display: flex; flex-direction: column; gap: 4px; padding: 10px; }
        .menu-btn span { width: 20px; height: 2px; background: var(--main); border-radius: 2px; }

        /* ä¾§è¾¹æ ä¸å…¬å‘Š */
        #sidePanel { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: #fff; z-index: 2000; transition: 0.3s; padding: 25px 20px; box-sizing: border-box; box-shadow: -5px 0 15px rgba(0,0,0,0.05); overflow-y: auto; }
        #sidePanel.open { right: 0; }
        .side-label { font-size: 10px; color: #bbb; margin: 15px 0 8px; display: block; text-transform: uppercase; border-bottom: 1px solid #f5f5f5; padding-bottom: 3px; }
        .ver-badge { background: var(--main); color: white; padding: 1px 5px; border-radius: 4px; font-size: 9px; margin-bottom: 3px; display: inline-block; }
        .notice-content { font-size: 12.5px; color: #444; line-height: 1.5; }
        
        /* ç½‘ç«™æ‹¥æœ‰è€…æ ·å¼ */
        .owner-section {
            background: rgba(242, 166, 116, 0.08);
            border-left: 2px solid var(--main);
            padding: 12px 12px;
            margin: 15px 0 15px 0;
            border-radius: 8px;
            font-size: 13px;
        }
        .owner-label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .owner-name {
            font-weight: bold;
            color: var(--main);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .owner-badge {
            background: var(--main);
            color: white;
            font-size: 8px;
            padding: 2px 5px;
            border-radius: 20px;
            letter-spacing: 0.5px;
        }

        /* ç™»å½•æ¡†å¢å¼º */
        .login-hint { font-size: 10px; color: #999; margin: 4px 0 8px; display: block; }
        .auth-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .auth-btn {
            flex: 1;
            background: var(--main);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .register-btn {
            flex: 1;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .register-btn:hover {
            background: #5a6268;
        }
        .auth-error {
            background: #ffebee;
            color: #c62828;
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 2px solid #c62828;
            display: none;
        }

        /* ä¸ªäººç­¾åæ ·å¼ */
        .signature-section {
            background: #f9f9f9;
            padding: 15px 12px;
            margin: 15px 0 15px 0;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        .signature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .signature-label {
            font-size: 11px;
            color: var(--main);
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .signature-owner-badge {
            background: rgba(242, 166, 116, 0.15);
            color: var(--main);
            font-size: 8px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 5px;
            border: 1px solid rgba(242, 166, 116, 0.3);
        }
        .signature-edit-btn {
            background: var(--main);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 9px;
            cursor: pointer;
            opacity: 0.8;
            transition: 0.2s;
        }
        .signature-edit-btn:hover {
            opacity: 1;
        }
        .signature-display {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
            word-break: break-word;
            background: white;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
            min-height: 36px;
        }
        .signature-edit-area {
            display: none;
            margin-top: 8px;
        }
        .signature-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        .signature-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .signature-save {
            flex: 1;
            background: var(--main);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px;
            font-size: 11px;
            cursor: pointer;
        }
        .signature-cancel {
            flex: 1;
            background: #eee;
            color: #666;
            border: none;
            border-radius: 6px;
            padding: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        /* æˆ‘çš„åŠ¨æ€å†å²æ ·å¼ */
        .history-section {
            background: #f0f7fa;
            padding: 10px;
            border-radius: 10px;
            margin: 15px 0 15px 0;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .history-header:hover {
            background: rgba(0,0,0,0.05);
        }
        .history-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-icon {
            font-size: 14px;
        }
        .history-title {
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
        }
        .history-count {
            background: var(--main);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 12px;
        }
        .history-arrow {
            font-size: 12px;
            color: #666;
            transition: transform 0.3s;
        }
        .history-arrow.expanded {
            transform: rotate(90deg);
        }
        .history-list-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out, margin 0.3s ease-in-out;
            margin-top: 0;
        }
        .history-list-container.expanded {
            max-height: 300px;
            opacity: 1;
            margin-top: 10px;
            overflow-y: auto;
        }
        .history-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            box-sizing: border-box;
            margin-bottom: 8px;
        }
        .history-item {
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 2px solid var(--main);
            font-size: 11px;
        }
        .history-item-content {
            color: #333;
            word-break: break-word;
            margin-bottom: 4px;
        }
        .history-item-time {
            color: #999;
            font-size: 9px;
        }
        .history-item-image {
            max-width: 50px;
            max-height: 50px;
            border-radius: 4px;
            margin-top: 4px;
            cursor: pointer;
        }
        .history-empty {
            text-align: center;
            color: #999;
            padding: 10px;
            font-size: 11px;
        }

        /* åŠ¨æ€å¡ç‰‡ - æ”¯æŒå¤šå›¾æ˜¾ç¤º */
        .card { 
            background: rgba(255,255,255,0.9); 
            padding: 12px 15px; 
            margin-bottom: 12px; 
            border-left: 3px solid var(--main); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            position: relative;
        }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 6px; 
        }
        .card-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .author-name { 
            font-size: 11.5px; 
            color: var(--main); 
            font-weight: bold; 
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .author-name:hover {
            background: rgba(242, 166, 116, 0.1);
        }
        .user-badge-display {
            background: var(--main);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 4px;
            display: inline-block;
            font-weight: normal;
        }
        .post-time { 
            font-size: 9px; 
            color: #ccc; 
        }
        .post-delete-btn {
            color: #ff4d4d;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.6;
            transition: 0.2s;
            padding: 0 4px;
        }
        .post-delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .post-text { 
            color: #444; 
            font-size: 13.5px; 
            line-height: 1.45; 
            white-space: pre-wrap; 
            margin-bottom: 8px; 
        }
        .post-images {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .post-image {
            width: calc(33.33% - 4px);
            max-height: 120px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            background: #f5f5f5;
            aspect-ratio: 1/1;
        }
        .post-image:hover {
            transform: scale(1.02);
        }

        /* æŒ‰é’®å¹¶æ’ */
        .action-bar { display: flex; border-top: 1px solid #fcfcfc; padding-top: 8px; }
        .action-btn { flex: 1; font-size: 11px; color: var(--main); cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 4px 0; }
        .action-btn:first-child { border-right: 1px solid #f5f5f5; }

        /* å¸ƒå±€å®¹å™¨ */
        .container { max-width: 480px; margin: 0 auto; padding: 0 12px; transition: opacity 0.2s; }
        #status { font-size: 10px; color: #999; text-align: center; margin-bottom: 10px; height: 14px; }
        .input-card { background: rgba(255,255,255,0.9); padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        textarea { width: 100%; height: 60px; border: 1px solid #f0f0f0; padding: 10px; box-sizing: border-box; font-size: 14px; outline: none; resize: none; background: #fdfdfd; }
        
        .btn { border: none; cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: var(--radius); }
        /* å‘å¸ƒåŒºåŸŸæŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            gap: 5%;
            margin-top: 8px;
        }
        .btn-pub { 
            flex: 0 0 75%; 
            background: var(--main); 
            color: white; 
            padding: 10px; 
            font-size: 14px; 
            box-sizing: border-box;
        }
        .btn-refresh { 
            flex: 0 0 20%; 
            background: rgba(0,0,0,0.05); 
            color: #666; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-sizing: border-box;
        }

        /* å›¾ç‰‡ä¸Šä¼ æŒ‰é’®æ ·å¼ï¼ˆæ–°å¸ƒå±€ç”¨ï¼‰ */
        .image-upload-btn {
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .image-upload-btn:hover {
            background: #e0e0e0;
        }
        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
            width: 100%;
        }
        .preview-item {
            position: relative;
            width: 70px;
            height: 70px;
        }
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¯„è®ºåŒºåŸŸ - æ°¸ä¹…æ˜¾ç¤ºèº«ä»½æ ‡ç­¾ */
        .comment-item {
            background: rgba(0,0,0,0.02);
            padding: 8px 10px;
            margin-top: 4px;
            font-size: 11px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .comment-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .comment-author {
            color: var(--main);
            font-weight: bold;
            cursor: pointer;
            padding: 0 2px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .comment-author:hover {
            background: rgba(242, 166, 116, 0.1);
        }
        .comment-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .comment-like {
            color: var(--main);
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .comment-delete {
            color: #ff4d4d;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.6;
            transition: 0.2s;
            padding: 0 4px;
        }
        .comment-delete:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .comment-input-group {
            display: flex;
            gap: 5%;
            margin-top: 6px;
            align-items: center;
        }
        .comment-input-field {
            flex: 0 0 75%;
            padding: 4px;
            font-size: 11px;
            border: 1px solid #eee;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .comment-send-btn {
            flex: 0 0 20%;
            background: var(--main);
            color: white;
            padding: 4px 0;
            font-size: 10px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: bold;
            box-sizing: border-box;
            text-align: center;
        }

        /* å›¾ç‰‡æŸ¥çœ‹å™¨å¼¹çª—æ ·å¼ */
        .image-viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            cursor: pointer;
        }
        .image-viewer-content {
            max-width: 90%;
            max-height: 90%;
        }
        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* ç”¨æˆ·ä¿¡æ¯å¼¹çª—æ ·å¼ */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .user-profile-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 280px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        .user-title {
            flex: 1;
        }
        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .user-badge {
            display: inline-block;
            background: var(--main);
            color: white;
            font-size: 9px;
            padding: 2px 8px;
            border-radius: 20px;
        }
        .user-signature {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
            line-height: 1.5;
            border-left: 3px solid var(--main);
        }
        .user-signature-label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .user-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .user-stat {
            flex: 1;
            text-align: center;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 10px;
        }
        .user-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--main);
        }
        .user-stat-label {
            font-size: 9px;
            color: #999;
            margin-top: 2px;
        }
        .close-profile-btn {
            width: 100%;
            padding: 10px;
            background: var(--main);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .close-profile-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        /* å¼€å‘è€…æ¨¡å¼ - ç”¨æˆ·èº«ä»½ç®¡ç†å’Œå®¡æ ¸åŠŸèƒ½ */
        .identity-manager {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .identity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .identity-header:hover {
            background: rgba(0,0,0,0.05);
        }
        .identity-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .identity-icon {
            font-size: 14px;
        }
        .identity-title {
            font-size: 11px;
            font-weight: bold;
            color: #2c3e50;
        }
        .identity-count {
            background: var(--main);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 12px;
        }
        .identity-arrow {
            font-size: 12px;
            color: #666;
            transition: transform 0.3s;
        }
        .identity-arrow.expanded {
            transform: rotate(90deg);
        }
        .identity-list {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out, margin 0.3s ease-in-out;
            margin-top: 0;
        }
        .identity-list.expanded {
            max-height: 200px;
            opacity: 1;
            margin-top: 10px;
            overflow-y: auto;
        }
        .identity-item {
            background: white;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 2px solid var(--main);
        }
        .identity-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .identity-user-avatar {
            width: 24px;
            height: 24px;
            background: var(--main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .identity-user-info {
            display: flex;
            flex-direction: column;
        }
        .identity-username {
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }
        .identity-userdate {
            font-size: 8px;
            color: #999;
        }
        .identity-status {
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 10px;
            background: #ffd700;
            color: #333;
            margin-left: 5px;
        }
        .identity-status.approved {
            background: #4caf50;
            color: white;
        }
        .identity-badge-edit {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .identity-badge-input {
            width: 70px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 10px;
        }
        .identity-save-btn {
            background: var(--main);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 9px;
            cursor: pointer;
        }
        .identity-save-btn:hover {
            opacity: 0.9;
        }
        .identity-approve-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 9px;
            cursor: pointer;
            margin-left: 5px;
        }
        .identity-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 9px;
            cursor: pointer;
            margin-left: 5px;
        }
        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            padding: 8px 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            gap: 5px;
        }
        .search-input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
        }
        .search-cancel {
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
        }
        .search-cancel:hover {
            background: #e0e0e0;
        }

        /* å®¡æ ¸å¼€å…³æ ·å¼ */
        .review-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .review-switch .mode-toggle {
            width: 44px;
            height: 22px;
        }

        /* æ–°å¢åˆ é™¤æƒé™å¼€å…³æ ·å¼ï¼Œå¤ç”¨ review-switch */
        .delete-permission-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .effect-preview {
            width: 100%;
            height: 50px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .effect-preview-shape {
            width: var(--preview-size, 30px);
            height: var(--preview-size, 30px);
            background: var(--preview-color, #F2A674);
            border-radius: var(--preview-radius, 50%);
            animation: previewPulse 1.5s infinite;
        }
        @keyframes previewPulse {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.8; }
        }
        .shape-selector {
            display: flex;
            gap: 10px;
            margin: 8px 0;
        }
        .shape-option {
            flex: 1;
            padding: 6px;
            text-align: center;
            background: #f0f0f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: 0.2s;
        }
        .shape-option.selected {
            background: var(--main);
            color: white;
        }

        /* å¼€å…³æ ·å¼ */
        .mode-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .mode-label {
            font-size: 11px;
            font-weight: bold;
            color: #333;
        }
        .mode-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        .mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 22px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--main);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        .status-badge {
            background: #ff9800;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* è®¾ç½®åˆ†ç±»æ ·å¼ - å¯æŠ˜å å¸¦åŠ¨ç”» */
        .settings-category {
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .category-header {
            background: #e0e0e0;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .category-header:hover {
            background: #d0d0d0;
        }
        .category-arrow {
            font-size: 12px;
            transition: transform 0.3s ease-in-out;
        }
        .category-arrow.expanded {
            transform: rotate(90deg);
        }
        .category-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out, padding 0.3s ease-in-out;
            padding: 0 10px;
        }
        .category-content.expanded {
            max-height: 500px;
            opacity: 1;
            padding: 10px;
        }

        #devModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 380px; background: white; z-index: 3000; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; display: none; border-radius: 20px; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 1999; backdrop-filter: blur(4px); }
        
        .rotating { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card, .input-card, .btn, .notice-box { border-radius: var(--radius) !important; }

        /* é€šç”¨å¼¹çª—æ ·å¼ */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .custom-modal {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 300px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }
        .modal-content {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
            white-space: pre-line;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .modal-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }
        .modal-btn.confirm {
            background: #ff4d4d;
            color: white;
        }
        .modal-btn.cancel {
            background: #f0f0f0;
            color: #666;
        }
        .modal-btn.ok {
            background: var(--main);
            color: white;
        }

        /* æ¬¢è¿æ ‡è¯­æ ·å¼ */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--main) 0%, #f8e3d0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            animation: fadeOut 2s ease-in-out forwards;
            pointer-events: none;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .welcome-content {
            text-align: center;
            color: white;
            animation: scaleIn 0.5s ease;
        }
        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .welcome-emoji {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .welcome-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .welcome-subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        /* æ–°å¢å·¥å…·ç•Œé¢æ ·å¼ - ç‹¬ç«‹ç©ºç™½é¡µ */
        #toolInterface {
            display: none;
            position: fixed;
            top: 55px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 500;
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .tool-content {
            max-width: 480px;
            margin: 0 auto;
            text-align: center;
            color: #666;
        }
        .tool-content h2 {
            color: var(--main);
            margin-bottom: 20px;
        }
        .back-hint {
            margin-top: 30px;
            font-size: 12px;
            color: #999;
        }
        /* AIå¥³å‹é•¿æ¡æŒ‰é’®æ ·å¼ï¼ˆä¿ç•™ä½†æœªä½¿ç”¨ï¼‰ */
        .ai-girl-btn {
            width: 100%;
            padding: 15px;
            background: var(--main);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.2s;
        }
        .ai-girl-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 20px;
        }
        .back-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>

    <!-- ç‚¹å‡»ç‰¹æ•ˆç”»å¸ƒ -->
    <canvas id="clickCanvas"></canvas>

    <!-- é€šç”¨å¼¹çª—å®¹å™¨ -->
    <div id="modalContainer"></div>

    <!-- ç”¨æˆ·ä¿¡æ¯å¼¹çª—å®¹å™¨ -->
    <div id="userProfileContainer"></div>

    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨å®¹å™¨ -->
    <div id="imageViewerContainer"></div>

    <!-- æ¬¢è¿æ ‡è¯­å®¹å™¨ - åŠ¨æ€ç”Ÿæˆ -->
    <div id="welcomeContainer"></div>

    <header>
        <!-- å·¦ä¾§logoï¼Œç‚¹å‡»è¿”å›ä¸»ç•Œé¢ -->
        <div class="logo" onclick="hideToolInterface()">å§å§çš„ä¸ªäººç©ºé—´</div>
        <!-- å³ä¾§ç»„ï¼šå·¥å…·æŒ‰é’® + èœå•æŒ‰é’® -->
        <div class="header-right-group">
            <button id="toolBtn" class="tool-btn" onclick="showToolInterface()" title="å·¥å…·">ğŸ”§</button>
            <button class="menu-btn" onclick="toggleMenu()"><span></span><span></span><span></span></button>
        </div>
    </header>

    <!-- å·¥å…·ç•Œé¢ (ç‹¬ç«‹ç©ºç™½é¡µ) -->
    <div id="toolInterface">
        <!-- å·¥å…·ä¸»é¡µ -->
        <div id="toolHome" style="display: block;">
            <div class="tool-content">
                <h2>ğŸ› ï¸ å·¥å…·ç•Œé¢</h2>
                <p>å·¥å…·é¡µé¢æµ‹è¯•é˜¶æ®µï¼Œæ¸©é¦¨æç¤ºç‚¹å‡»å·¦è¾¹logoä¹Ÿèƒ½è¿”å›ä¸»é¡µ</p>
                <button class="back-btn" onclick="hideToolInterface()">è¿”å›ä¸»é¡µ</button>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="closeAll()"></div>

    <div id="sidePanel">
        <span class="side-label">ğŸ“¢ å…¬å‘Šæ </span>
        <div id="currentNotice">
            <span class="ver-badge" id="verDisplay">v10.0.0</span>
            <div class="notice-content" id="noticeText">åŠ è½½ä¸­...</div>
        </div>

        <span style="font-size:11px; color:var(--main); cursor:pointer; margin-top:8px; display:block" onclick="toggleHistory()">å†å²æ›´æ–°è®°å½• â†“</span>
        <div id="historyBox" style="display:none; margin-top:10px; border-top:1px dashed #eee; padding-top:8px"></div>

        <!-- ç½‘ç«™æ‹¥æœ‰è€…ä¿¡æ¯ -->
        <div class="owner-section">
            <div class="owner-label">ğŸ‘‘ ç½‘ç«™æ‹¥æœ‰è€…</div>
            <div class="owner-name">
                é¥­é¥­ <span class="owner-badge">åˆ›å§‹äºº/æŸšå°å±¿</span>
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">âœ¨ è®°å½•ç”Ÿæ´»ï¼Œåˆ†äº«ç¾å¥½</div>
        </div>

        <span class="side-label">ğŸ‘¤ è®¿å®¢ç™»å½•/æ³¨å†Œ</span>
        <div id="userSection" style="background:#f9f9f9; padding:12px; border-radius:10px; border:1px solid #eee">
            <div id="loginForm">
                <input type="text" id="uName" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; font-size:12px; box-sizing:border-box" placeholder="ä½ çš„æ˜µç§°">
                <input type="password" id="uPass" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; font-size:12px; margin-top:6px; box-sizing:border-box" placeholder="å¯†ç ">
                <span class="login-hint">ğŸ”’ å¯†ç ä¸èƒ½å°‘äº 6 ä¸ªå­—ç¬¦</span>
                <div id="authError" class="auth-error"></div>
                <div class="auth-buttons">
                    <button class="auth-btn" onclick="handleLogin()">ç™»å½•</button>
                    <button class="register-btn" onclick="handleRegister()">æ³¨å†Œ</button>
                </div>
            </div>
            <div id="userInfo" style="display:none">
                <span style="font-size:12px">æ¬¢è¿ï¼Œ<b id="currUser" style="color:var(--main)"></b></span>
                <button class="btn" style="background:#eee; font-size:10px; padding:2px 8px; margin-left:5px" onclick="logout()">æ³¨é”€</button>
            </div>
        </div>

        <!-- ä¸ªäººç­¾ååŒºåŸŸ -->
        <div class="signature-section">
            <div class="signature-header">
                <span class="signature-label">
                    ğŸ“ ä¸ªäººç­¾å 
                    <span id="signatureOwner" class="signature-owner-badge">æœªç™»å½•</span>
                </span>
                <button class="signature-edit-btn" onclick="toggleSignatureEdit()">ç¼–è¾‘</button>
            </div>
            <div id="signatureDisplay" class="signature-display">åŠ è½½ä¸­...</div>
            <div id="signatureEditArea" class="signature-edit-area">
                <textarea id="signatureInput" class="signature-input" placeholder="å†™ä¸€å¥ä½ çš„ä¸ªäººç­¾å..."></textarea>
                <div class="signature-actions">
                    <button class="signature-save" onclick="saveSignature()">ä¿å­˜åˆ°äº‘ç«¯</button>
                    <button class="signature-cancel" onclick="cancelSignatureEdit()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„åŠ¨æ€å†å²åŒºåŸŸ -->
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-header" onclick="toggleUserHistory()">
                <div class="history-header-left">
                    <span class="history-icon">ğŸ“œ</span>
                    <span class="history-title">æˆ‘çš„åŠ¨æ€å†å²</span>
                    <span class="history-count" id="userHistoryCount">0</span>
                </div>
                <span class="history-arrow" id="historyArrow">â–¶</span>
            </div>
            <div class="history-list-container" id="historyListContainer">
                <input type="text" id="historySearchInput" class="history-search" placeholder="æœç´¢æˆ‘çš„åŠ¨æ€..." oninput="filterUserHistory()">
                <div id="userHistoryList"></div>
            </div>
        </div>

        <button class="btn" style="background:#444; color:white; width:100%; margin-top:15px; padding:8px; font-size:12px" onclick="showDevAuth()">ğŸ› ï¸ å¼€å‘è€…æ¨¡å¼</button>
        <div id="devAuthArea" style="display:none; margin-top:8px">
            <input type="password" id="devPassInput" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box" placeholder="å£ä»¤">
            <button class="btn btn-pub" style="width:100%; margin-top:5px; padding:6px" onclick="verifyDevPass()">ç¡®è®¤è¿›å…¥</button>
        </div>
    </div>

    <div id="devModal">
        <h3 style="margin:0 0 15px; text-align:center; font-size:16px">ğŸ› ï¸ å¼€å‘è€…é…ç½®</h3>
        
        <!-- æ³¨å†Œå®¡æ ¸å¼€å…³ -->
        <div style="background:#e0f0e0; padding:10px; border-radius:10px; margin-bottom:15px">
            <label style="font-size:11px; font-weight:bold">ğŸ” æ³¨å†Œå®¡æ ¸</label>
            <div class="review-switch">
                <span class="mode-label">
                    éœ€è¦å®¡æ ¸ 
                    <span class="status-badge" id="reviewModeBadge" style="background:#ff9800">å…³é—­</span>
                </span>
                <label class="mode-toggle">
                    <input type="checkbox" id="reviewModeToggle" onchange="toggleReviewMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px; padding:0 5px;">
                å¼€å¯åæ–°ç”¨æˆ·æ³¨å†Œéœ€è¦ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡æ‰èƒ½ç™»å½•
            </div>
        </div>

        <!-- æ–°å¢ï¼šå…è®¸åˆ é™¤ä»–äººåŠ¨æ€å¼€å…³ -->
        <div style="background:#ffe0e0; padding:10px; border-radius:10px; margin-bottom:15px">
            <label style="font-size:11px; font-weight:bold">ğŸ—‘ï¸ åˆ é™¤ä»–äººåŠ¨æ€</label>
            <div class="delete-permission-switch">
                <span class="mode-label">
                    å…è®¸åˆ é™¤ 
                    <span class="status-badge" id="deleteOthersBadge" style="background:#999">å…³é—­</span>
                </span>
                <label class="mode-toggle">
                    <input type="checkbox" id="deleteOthersToggle" onchange="toggleDeleteOthers()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px; padding:0 5px;">
                å¼€å¯åå¯ä»¥åˆ é™¤ä»»æ„ç”¨æˆ·å‘å¸ƒçš„åŠ¨æ€ï¼ˆæ— è®ºæ˜¯å¦ä¸ºè‡ªå·±å‘å¸ƒï¼‰
            </div>
        </div>

        <!-- ç”¨æˆ·èº«ä»½ç®¡ç† -->
        <div class="identity-manager">
            <div class="identity-header" onclick="toggleIdentityList()">
                <div class="identity-header-left">
                    <span class="identity-icon">ğŸ‘¥</span>
                    <span class="identity-title">ç”¨æˆ·ç®¡ç†ï¼ˆèº«ä»½+å®¡æ ¸+æ°¸ä¹…åˆ é™¤ï¼‰</span>
                    <span class="identity-count" id="userCount">0</span>
                </div>
                <span class="identity-arrow" id="identityArrow">â–¶</span>
            </div>
            <div class="identity-list" id="identityList">
                <!-- æœç´¢æ¡† -->
                <div class="search-container">
                    <input type="text" id="userSearchInput" class="search-input" placeholder="è¾“å…¥ç”¨æˆ·åæœç´¢..." oninput="filterUserList()">
                    <button class="search-cancel" onclick="clearUserSearch()">å–æ¶ˆ</button>
                </div>
                <!-- ç”¨æˆ·åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
                <div id="userListContainer"></div>
            </div>
        </div>

        <!-- å…¬å‘Šæ›´æ–°åŒºåŸŸ -->
        <div style="background:#f0f7ff; padding:10px; border-radius:10px; margin-bottom:15px">
            <label style="font-size:11px; font-weight:bold">å…¬å‘Šæ›´æ–°</label>
            <input type="text" id="devVer" style="width:100%; margin-top:4px; padding:5px; font-size:12px; box-sizing:border-box" placeholder="ç‰ˆæœ¬å·">
            <textarea id="devNotice" style="width:100%; height:40px; margin-top:4px; padding:5px; font-size:12px; box-sizing:border-box" placeholder="å†…å®¹..."></textarea>
        </div>

        <!-- å¯æŠ˜å çš„è®¾ç½®åˆ†ç±» -->
        <div class="settings-category">
            <div class="category-header" onclick="toggleSettingsCategory()">
                <span class="category-arrow" id="settingsArrow">â–¶</span>
                <span>âš™ï¸ è®¾ç½®</span>
            </div>
            <div class="category-content" id="settingsContent">
                <!-- ç‚¹å‡»ç‰¹æ•ˆè®¾ç½®åŒºåŸŸ -->
                <div style="background:#fff3e0; padding:10px; border-radius:10px; margin-bottom:10px">
                    <label style="font-size:11px; font-weight:bold">âœ¨ ç‚¹å‡»ç‰¹æ•ˆè®¾ç½®</label>
                    
                    <!-- ç‰¹æ•ˆé¢œè‰² -->
                    <div style="margin-top:8px">
                        <label style="font-size:10px; color:#666">ç‰¹æ•ˆé¢œè‰²</label>
                        <input type="color" id="effectColor" style="width:100%; height:35px; margin-top:4px" value="#F2A674">
                    </div>
                    
                    <!-- ç‰¹æ•ˆå¤§å° -->
                    <div style="margin-top:8px">
                        <label style="font-size:10px; color:#666">ç‰¹æ•ˆå¤§å°: <span id="effectSizeVal">30px</span></label>
                        <input type="range" id="effectSize" min="10" max="60" value="30" style="width:100%">
                    </div>
                    
                    <!-- ç‰¹æ•ˆå½¢çŠ¶é€‰æ‹© -->
                    <div style="margin-top:8px">
                        <label style="font-size:10px; color:#666">ç‰¹æ•ˆå½¢çŠ¶</label>
                        <div class="shape-selector" id="shapeSelector">
                            <div class="shape-option selected" data-shape="circle" onclick="selectShape('circle')">âšª åœ†å½¢</div>
                            <div class="shape-option" data-shape="square" onclick="selectShape('square')">â¬› æ–¹å½¢</div>
                            <div class="shape-option" data-shape="triangle" onclick="selectShape('triangle')">ğŸ”º ä¸‰è§’å½¢</div>
                        </div>
                    </div>
                    
                    <!-- ç‰¹æ•ˆé¢„è§ˆ -->
                    <div style="margin-top:8px">
                        <label style="font-size:10px; color:#666">å®æ—¶é¢„è§ˆ</label>
                        <div class="effect-preview" id="effectPreview">
                            <div class="effect-preview-shape" id="previewShape"></div>
                        </div>
                    </div>
                </div>

                <!-- ä¸»é¢˜è®¾ç½®åŒºåŸŸ -->
                <div style="background:#f0f0f0; padding:10px; border-radius:10px">
                    <label style="font-size:11px; font-weight:bold">ğŸ¨ ä¸»é¢˜è®¾ç½®</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px">
                        <div><label style="font-size:11px">ä¸»è‰²</label><input type="color" id="themeColor" style="width:100%" value="#F2A674"></div>
                        <div><label style="font-size:11px">èƒŒæ™¯è‰²</label><input type="color" id="bgColor" style="width:100%" value="#EBEBEB"></div>
                    </div>
                    <div style="margin-top:8px"><label style="font-size:11px">èƒŒæ™¯å›¾ URL</label><input type="text" id="bgUrl" style="width:100%; padding:5px; font-size:12px; box-sizing:border-box"></div>
                    <div style="margin-top:8px">
                        <label style="font-size:11px">UI åœ†è§’: <span id="radiusVal">12px</span></label>
                        <input type="range" id="radiusRange" min="0" max="25" style="width:100%">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="display:flex; flex-direction:column; gap:6px; margin-top:15px">
            <button class="btn btn-pub" onclick="saveSettingsToCloud()">åŒæ­¥å‘å¸ƒ</button>
            <button class="btn" style="background:#eee; padding:8px" onclick="closeAll()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div id="status">è¿æ¥ä¸­...</div>
        <div class="input-card">
            <!-- æ–°å¸ƒå±€ï¼šæŒ‰é’®åœ¨å·¦ä¾§ï¼Œè¾“å…¥æ¡†åœ¨å³ä¾§ -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <input type="file" id="imageInput" accept="image/*" multiple style="display:none" onchange="handleImageSelect(event)">
                <button class="image-upload-btn" onclick="document.getElementById('imageInput').click()">
                    <span>ğŸ“·</span> å›¾ç‰‡
                </button>
                <textarea id="msgInput" placeholder="åˆ†äº«åŠ¨æ€..." style="flex:1; height:40px; margin-bottom:0;"></textarea>
            </div>
            <div class="image-previews" id="imagePreviews"></div>
            <div class="btn-group">
                <button class="btn btn-pub" onclick="publish()">å‘å¸ƒ</button>
                <button class="btn btn-refresh" onclick="loadData()"><span id="refreshIcon">â†»</span></button>
            </div>
        </div>

        <!-- æ–°å¢ï¼šåŠ¨æ€æœç´¢æ¡†ï¼Œä»…ç™»å½•ç”¨æˆ·å¯è§ -->
        <div id="postSearchContainer" style="display: none; margin: 10px 0;">
            <input type="text" id="postSearchInput" placeholder="æœç´¢æ‰€æœ‰äººå‘å¸ƒçš„åŠ¨æ€..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
            <button id="postSearchClear" style="margin-top: 5px; background: #f0f0f0; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">å–æ¶ˆ</button>
        </div>

        <div id="msgList"></div>
    </div>

    <script>
        const CONFIG = {
            KEY: "$2a$10$RhcPZqRZZjdSWEp85cbSb.xngZSGZeda4a25br/od0U9pyqLcKBja", 
            BIN: "699c4b22ae596e708f424292",
            DEV_PASS: "ä½œè€…æœ€å¸…"
        };
        const DEFAULT_S = { 
            theme: "#F2A674", 
            bgCol: "#EBEBEB", 
            bgImg: "", 
            font: "-apple-system, sans-serif", 
            radius: 12, 
            currentVer: "v1.0", 
            notice: "æ¬¢è¿å…‰ä¸´ï¼", 
            history: [],
            effect: {
                color: "#F2A674",
                size: 30,
                shape: "circle"
            },
            reviewMode: false,
            allowDeleteOthers: false, // æ–°å¢ï¼šå…è®¸åˆ é™¤ä»–äººåŠ¨æ€
            userBadges: {},
            userStatus: {}
        };
        let currentUser = localStorage.getItem('sister_user') || null;
        let currentSignature = "âœ¨ è¿™ä¸ªäººå¾ˆæ‡’ï¼Œè¿˜æ²¡æœ‰ç­¾å~";
        let signatureOwner = null;
        let users = [];
        let effectSettings = { color: "#F2A674", size: 30, shape: "circle" };
        let particles = [];
        let reviewMode = false;
        let allowDeleteOthers = false; // æ–°å¢çŠ¶æ€
        let userBadges = {};
        let userStatus = {};
        let currentSearchTerm = ''; // å½“å‰ç”¨æˆ·ç®¡ç†æœç´¢è¯
        let selectedImages = []; // å­˜å‚¨é€‰æ‹©çš„å›¾ç‰‡æ–‡ä»¶ { file, preview }
        let notes = []; // å­˜å‚¨æ‰€æœ‰åŠ¨æ€
        let userHistorySearchTerm = ''; // å†å²è®°å½•æœç´¢è¯
        let postSearchTerm = ''; // å…¨å±€åŠ¨æ€æœç´¢è¯

        // å·¥å…·ç•Œé¢æ§åˆ¶å‡½æ•°
        function showToolInterface() {
            if (!currentUser) return; // ä»…ç™»å½•ç”¨æˆ·å¯ç‚¹ï¼Œä½†æŒ‰é’®å·²éšè—ï¼Œä»¥é˜²ä¸‡ä¸€
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('toolInterface').style.display = 'block';
            // æ¯æ¬¡æ˜¾ç¤ºå·¥å…·ç•Œé¢æ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºå·¥å…·ä¸»é¡µ
            showToolHome();
        }

        function hideToolInterface() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('toolInterface').style.display = 'none';
        }

        // å·¥å…·å†…å­é¡µé¢åˆ‡æ¢
        function showAiGirlPage() {
            document.getElementById('toolHome').style.display = 'none';
            document.getElementById('aiGirlPage').style.display = 'block';
        }

        function showToolHome() {
            document.getElementById('toolHome').style.display = 'block';
            document.getElementById('aiGirlPage').style.display = 'none';
        }

        // å›¾ç‰‡å‹ç¼©å‡½æ•°
        function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            const reader2 = new FileReader();
                            reader2.readAsDataURL(compressedFile);
                            reader2.onload = (e2) => {
                                resolve(e2.target.result);
                            };
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // å¤šå›¾å¤„ç†å‡½æ•°
        async function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length + selectedImages.length > 3) {
                showAuthError("æœ€å¤šåªèƒ½é€‰æ‹©3å¼ å›¾ç‰‡");
                return;
            }
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showAuthError("å•å¼ å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB");
                    return;
                }
            }
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImages.push({
                        file: file,
                        preview: e.target.result
                    });
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviews');
            container.innerHTML = '';
            selectedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${img.preview}" class="preview-image">
                    <button class="remove-image-btn" onclick="removeImage(${index})">Ã—</button>
                `;
                container.appendChild(div);
            });
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            renderImagePreviews();
        }

        function clearImages() {
            selectedImages = [];
            renderImagePreviews();
        }

        function showImageViewer(imageUrl) {
            const container = document.getElementById('imageViewerContainer');
            container.innerHTML = `
                <div class="image-viewer-overlay" onclick="this.remove()">
                    <div class="image-viewer-content">
                        <img src="${imageUrl}" alt="æŸ¥çœ‹å›¾ç‰‡" oncontextmenu="return true">
                    </div>
                </div>
            `;
        }

        // åˆ‡æ¢è®¾ç½®åˆ†ç±»æŠ˜å çŠ¶æ€
        function toggleSettingsCategory() {
            const content = document.getElementById('settingsContent');
            const arrow = document.getElementById('settingsArrow');
            content.classList.toggle('expanded');
            arrow.classList.toggle('expanded');
        }

        // æ˜¾ç¤ºæ¬¢è¿æ ‡è¯­
        function showWelcomeBanner() {
            const container = document.getElementById('welcomeContainer');
            const hours = new Date().getHours();
            let greeting = '';
            if (hours < 12) {
                greeting = 'æ—©ä¸Šå¥½';
            } else if (hours < 18) {
                greeting = 'ä¸‹åˆå¥½';
            } else {
                greeting = 'æ™šä¸Šå¥½';
            }
            const username = currentUser || 'æœ‹å‹';
            // è·å–å½“å‰ç‰ˆæœ¬å·ï¼ˆä»å…¬å‘Šæ å…ƒç´ ï¼‰
            const versionEl = document.getElementById('verDisplay');
            const version = versionEl ? versionEl.innerText : 'v1.0.0';
            container.innerHTML = `
                <div class="welcome-overlay">
                    <div class="welcome-content">
                        <div class="welcome-emoji">âœ¨</div>
                        <div class="welcome-title">${greeting}ï¼Œ${username}</div>
                        <div class="welcome-subtitle">æ¬¢è¿å›æ¥å§å§çš„ä¸ªäººç©ºé—´  ${version}</div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 2000);
        }

        // æ˜¾ç¤ºé€šç”¨å¼¹çª—
        function showModal(options) {
            const {
                title = 'æç¤º',
                content = '',
                showCancel = true,
                confirmText = 'ç¡®å®š',
                cancelText = 'å–æ¶ˆ',
                onConfirm,
                onCancel
            } = options;
            const container = document.getElementById('modalContainer');
            container.innerHTML = `
                <div class="custom-modal-overlay" onclick="if(event.target===this) closeModal()">
                    <div class="custom-modal">
                        <div class="modal-title">${title}</div>
                        <div class="modal-content">${content}</div>
                        <div class="modal-buttons">
                            ${showCancel ? `
                                <button class="modal-btn cancel" onclick="closeModal()">${cancelText}</button>
                                <button class="modal-btn confirm" onclick="closeModal(); ${onConfirm ? '(' + onConfirm + ')' : ''}">${confirmText}</button>
                            ` : `
                                <button class="modal-btn ok" onclick="closeModal(); ${onConfirm ? '(' + onConfirm + ')' : ''}">${confirmText}</button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // åˆ‡æ¢å®¡æ ¸æ¨¡å¼
        function toggleReviewMode() {
            const toggle = document.getElementById('reviewModeToggle');
            reviewMode = toggle.checked;
            const badge = document.getElementById('reviewModeBadge');
            badge.innerText = reviewMode ? 'å¼€å¯' : 'å…³é—­';
            badge.style.background = reviewMode ? '#4caf50' : '#ff9800';
            if (document.getElementById('identityList').classList.contains('expanded')) {
                renderUserList();
            }
        }

        // æ–°å¢ï¼šåˆ‡æ¢åˆ é™¤ä»–äººåŠ¨æ€æƒé™
        function toggleDeleteOthers() {
            const toggle = document.getElementById('deleteOthersToggle');
            allowDeleteOthers = toggle.checked;
            const badge = document.getElementById('deleteOthersBadge');
            badge.innerText = allowDeleteOthers ? 'å¼€å¯' : 'å…³é—­';
            badge.style.background = allowDeleteOthers ? '#ff4d4d' : '#999';
            // é‡æ–°æ¸²æŸ“åŠ¨æ€åˆ—è¡¨ä»¥æ›´æ–°åˆ é™¤æŒ‰é’®æ˜¾ç¤º
            render(notes);
        }

        // åˆ‡æ¢ç”¨æˆ·èº«ä»½åˆ—è¡¨æ˜¾ç¤º - å¸¦åŠ¨ç”»
        function toggleIdentityList() {
            const list = document.getElementById('identityList');
            const arrow = document.getElementById('identityArrow');
            if (list.classList.contains('expanded')) {
                list.classList.remove('expanded');
                arrow.classList.remove('expanded');
                setTimeout(() => {
                    if (!list.classList.contains('expanded')) {
                        document.getElementById('userListContainer').innerHTML = '';
                    }
                }, 300);
            } else {
                renderUserList();
                setTimeout(() => {
                    list.classList.add('expanded');
                    arrow.classList.add('expanded');
                }, 10);
            }
        }

        // è¿‡æ»¤ç”¨æˆ·åˆ—è¡¨
        function filterUserList() {
            const searchInput = document.getElementById('userSearchInput');
            currentSearchTerm = searchInput.value.toLowerCase().trim();
            renderUserList();
        }

        function clearUserSearch() {
            document.getElementById('userSearchInput').value = '';
            currentSearchTerm = '';
            renderUserList();
        }

        function renderUserList() {
            const container = document.getElementById('userListContainer');
            const userCount = document.getElementById('userCount');
            if (!users || users.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:10px; color:#999">æš‚æ— ç”¨æˆ·</div>';
                userCount.innerText = '0';
                return;
            }
            let filteredUsers = users;
            if (currentSearchTerm) {
                filteredUsers = users.filter(user => 
                    user.username.toLowerCase().includes(currentSearchTerm)
                );
            }
            userCount.innerText = filteredUsers.length;
            if (filteredUsers.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:10px; color:#999">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</div>';
                return;
            }
            let html = '';
            filteredUsers.forEach(user => {
                const badge = userBadges[user.username] || 'æ™®é€šç”¨æˆ·';
                const status = userStatus[user.username] || 'approved';
                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'æœªçŸ¥';
                let statusHtml = '';
                if (status === 'pending') {
                    statusHtml = '<span class="identity-status">å¾…å®¡æ ¸</span>';
                } else if (status === 'approved') {
                    statusHtml = '<span class="identity-status approved">å·²é€šè¿‡</span>';
                }
                html += `
                    <div class="identity-item">
                        <div class="identity-user">
                            <div class="identity-user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                            <div class="identity-user-info">
                                <span class="identity-username">${user.username} ${statusHtml}</span>
                                <span class="identity-userdate">æ³¨å†Œ: ${createdDate}</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div class="identity-badge-edit">
                                <input type="text" class="identity-badge-input" id="badge-${user.username}" value="${badge}" placeholder="èº«ä»½">
                                <button class="identity-save-btn" onclick="saveUserBadge('${user.username}')">ä¿å­˜</button>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                ${status === 'pending' ? `
                                    <button class="identity-approve-btn" onclick="approveUser('${user.username}')">é€šè¿‡</button>
                                    <button class="identity-delete-btn" onclick="showDeleteUserConfirm('${user.username}')">æ‹’ç»å¹¶åˆ é™¤</button>
                                ` : `
                                    <button class="identity-delete-btn" onclick="showDeleteUserConfirm('${user.username}')">æ°¸ä¹…åˆ é™¤</button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºåˆ é™¤ç”¨æˆ·ç¡®è®¤å¼¹çª—
        function showDeleteUserConfirm(username) {
            showModal({
                title: 'âš ï¸ æ°¸ä¹…åˆ é™¤ç”¨æˆ·',
                content: `ç”¨æˆ·ï¼š${username}\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ï¼š\nâ€¢ ç”¨æˆ·è´¦å·\nâ€¢ æ‰€æœ‰å‘å¸ƒçš„åŠ¨æ€\nâ€¢ æ‰€æœ‰è¯„è®º\nâ€¢ ä¸ªäººç­¾å\nâ€¢ èº«ä»½æ ‡ç­¾\n\nåˆ é™¤åä¸å¯æ¢å¤ï¼`,
                confirmText: 'ç¡®å®šåˆ é™¤',
                onConfirm: `deleteUserPermanently('${username}')`
            });
        }

        // é€šè¿‡ç”¨æˆ·å®¡æ ¸
        async function approveUser(username) {
            userStatus[username] = 'approved';
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                const updatedRecord = {
                    ...data.record,
                    userStatus: userStatus
                };
                await updateCloud(updatedRecord);
                showAuthError(`âœ… å·²é€šè¿‡ç”¨æˆ· ${username} çš„å®¡æ ¸ï¼Œè¯¥ç”¨æˆ·å¯ä»¥ç™»å½•äº†`);
                setTimeout(hideAuthError, 3000);
                renderUserList();
            } catch (e) {
                showAuthError("âŒ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
                setTimeout(hideAuthError, 2000);
            }
        }

        // æ°¸ä¹…åˆ é™¤ç”¨æˆ·
        async function deleteUserPermanently(username) {
            try {
                users = users.filter(u => u.username !== username);
                delete userBadges[username];
                delete userStatus[username];
                if (window.signatureData && window.signatureData.owner === username) {
                    window.signatureData = null;
                }
                if (signatureOwner === username) {
                    currentSignature = "âœ¨ è¿™ä¸ªäººå¾ˆæ‡’ï¼Œè¿˜æ²¡æœ‰ç­¾å~";
                    signatureOwner = null;
                }
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                let notesData = data.record.notes || [];
                notesData = notesData.map(note => {
                    if (note.author === username) {
                        return null;
                    }
                    if (note.comments) {
                        note.comments = note.comments.filter(c => c.user !== username);
                    }
                    return note;
                }).filter(note => note !== null);
                const updatedRecord = {
                    ...data.record,
                    users: users,
                    userBadges: userBadges,
                    userStatus: userStatus,
                    notes: notesData,
                    signature: window.signatureData
                };
                await updateCloud(updatedRecord);
                showAuthError(`âœ… å·²æ°¸ä¹…åˆ é™¤ç”¨æˆ· ${username} åŠå…¶æ‰€æœ‰ç›¸å…³å†…å®¹`);
                setTimeout(hideAuthError, 3000);
                if (currentUser === username) {
                    logout();
                }
                renderUserList();
            } catch (e) {
                showAuthError("âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
                setTimeout(hideAuthError, 2000);
            }
        }

        // ä¿å­˜ç”¨æˆ·èº«ä»½æ ‡ç­¾
        async function saveUserBadge(username) {
            const input = document.getElementById(`badge-${username}`);
            const newBadge = input.value.trim() || 'æ™®é€šç”¨æˆ·';
            userBadges[username] = newBadge;
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                const updatedBadges = {
                    ...(data.record.userBadges || {}),
                    [username]: newBadge
                };
                const updatedRecord = {
                    ...data.record,
                    userBadges: updatedBadges
                };
                await updateCloud(updatedRecord);
                showAuthError(`âœ… å·²å°† ${username} çš„èº«ä»½æ°¸ä¹…æ”¹ä¸º "${newBadge}"ï¼Œæ‰€æœ‰äººå¯è§`);
                setTimeout(hideAuthError, 3000);
                await loadData();
            } catch (e) {
                showAuthError("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
                setTimeout(hideAuthError, 2000);
            }
        }

        function getUserBadge(username) {
            return userBadges[username] || 'æ™®é€šç”¨æˆ·';
        }

        function canUserLogin(username) {
            if (!reviewMode) return true;
            const status = userStatus[username];
            return status === 'approved';
        }

        function showUserProfile(username) {
            let userSignature = "è¿™ä¸ªäººè¿˜æ²¡æœ‰è®¾ç½®ç­¾å~";
            if (window.signatureData && window.signatureData.owner === username) {
                userSignature = window.signatureData.content;
            } else if (signatureOwner === username) {
                userSignature = currentSignature;
            }
            const badge = getUserBadge(username);
            const container = document.getElementById('userProfileContainer');
            container.innerHTML = `
                <div class="user-profile-overlay" onclick="if(event.target===this) this.remove()">
                    <div class="user-profile-card">
                        <div class="user-profile-header">
                            <div class="user-avatar">${username.charAt(0).toUpperCase()}</div>
                            <div class="user-title">
                                <div class="user-name">${username}</div>
                                <span class="user-badge">${badge}</span>
                            </div>
                        </div>
                        <div class="user-signature">
                            <div class="user-signature-label">ğŸ“ ä¸ªæ€§ç­¾å</div>
                            <div>${userSignature}</div>
                        </div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value" id="userPostCount">...</div>
                                <div class="user-stat-label">åŠ¨æ€</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value" id="userCommentCount">...</div>
                                <div class="user-stat-label">è¯„è®º</div>
                            </div>
                        </div>
                        <button class="close-profile-btn" onclick="this.closest('.user-profile-overlay').remove()">å…³é—­</button>
                    </div>
                </div>
            `;
            loadUserStats(username).then(stats => {
                const postCountEl = document.getElementById('userPostCount');
                const commentCountEl = document.getElementById('userCommentCount');
                if (postCountEl) postCountEl.innerText = stats.posts;
                if (commentCountEl) commentCountEl.innerText = stats.comments;
            });
        }

        async function loadUserStats(username) {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest?v=${Date.now()}`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const d = await res.json();
                const notesData = d.record.notes || [];
                let postCount = 0;
                let commentCount = 0;
                notesData.forEach(note => {
                    if (note.author === username) postCount++;
                    (note.comments || []).forEach(comment => {
                        if (comment.user === username) commentCount++;
                    });
                });
                return { posts: postCount, comments: commentCount };
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¤±è´¥', e);
                return { posts: 0, comments: 0 };
            }
        }

        function showDeleteConfirm(message, onConfirm) {
            showModal({
                title: 'ç¡®è®¤åˆ é™¤',
                content: message,
                confirmText: 'ç¡®å®š',
                onConfirm: onConfirm
            });
        }

        // ç‚¹å‡»ç‰¹æ•ˆç³»ç»Ÿ
        class Particle {
            constructor(x, y, color, size, shape) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = size;
                this.shape = shape;
                this.age = 0;
                this.maxAge = 30;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4 - 2;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1;
                this.age++;
                return this.age < this.maxAge;
            }
            draw(ctx) {
                const opacity = 1 - (this.age / this.maxAge);
                ctx.globalAlpha = opacity;
                ctx.fillStyle = this.color;
                const currentSize = this.size * (1 - this.age / this.maxAge * 0.5);
                ctx.beginPath();
                if (this.shape === 'circle') {
                    ctx.arc(this.x, this.y, currentSize / 2, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.shape === 'square') {
                    ctx.fillRect(this.x - currentSize/2, this.y - currentSize/2, currentSize, currentSize);
                } else if (this.shape === 'triangle') {
                    ctx.moveTo(this.x, this.y - currentSize/2);
                    ctx.lineTo(this.x - currentSize/2, this.y + currentSize/2);
                    ctx.lineTo(this.x + currentSize/2, this.y + currentSize/2);
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
        }

        function initClickEffect() {
            const canvas = document.getElementById('clickCanvas');
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            document.addEventListener('click', (e) => {
                if (e.target.closest('#devModal') || e.target.closest('#sidePanel') || e.target.closest('.btn')) {
                    return;
                }
                const particleCount = 5 + Math.floor(Math.random() * 4);
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new Particle(
                        e.clientX, 
                        e.clientY, 
                        effectSettings.color,
                        effectSettings.size,
                        effectSettings.shape
                    ));
                }
            });
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles = particles.filter(p => p.update());
                particles.forEach(p => p.draw(ctx));
                requestAnimationFrame(animate);
            }
            animate();
        }

        function selectShape(shape) {
            document.querySelectorAll('.shape-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
            updatePreview();
        }

        function updatePreview() {
            const color = document.getElementById('effectColor').value;
            const size = document.getElementById('effectSize').value;
            const shape = document.querySelector('.shape-option.selected')?.dataset.shape || 'circle';
            const preview = document.getElementById('previewShape');
            preview.style.setProperty('--preview-color', color);
            preview.style.setProperty('--preview-size', size + 'px');
            if (shape === 'circle') {
                preview.style.borderRadius = '50%';
                preview.style.background = color;
                preview.style.border = 'none';
                preview.style.width = size + 'px';
                preview.style.height = size + 'px';
            } else if (shape === 'square') {
                preview.style.borderRadius = '0';
                preview.style.background = color;
                preview.style.border = 'none';
                preview.style.width = size + 'px';
                preview.style.height = size + 'px';
            } else if (shape === 'triangle') {
                preview.style.borderRadius = '0';
                preview.style.width = '0';
                preview.style.height = '0';
                preview.style.borderLeft = size/2 + 'px solid transparent';
                preview.style.borderRight = size/2 + 'px solid transparent';
                preview.style.borderBottom = size + 'px solid ' + color;
                preview.style.background = 'transparent';
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.style.display = 'block';
            errorDiv.innerText = message;
        }

        function hideAuthError() {
            const errorDiv = document.getElementById('authError');
            errorDiv.style.display = 'none';
            errorDiv.innerText = '';
        }

        async function loadUsers() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest?v=${Date.now()}`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const d = await res.json();
                if (d.record.users) {
                    users = d.record.users;
                } else {
                    users = [];
                }
                return users;
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥', e);
                return [];
            }
        }

        async function saveUsers(updatedUsers) {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                const updatedRecord = {
                    ...data.record,
                    users: updatedUsers
                };
                await updateCloud(updatedRecord);
                return true;
            } catch (e) {
                console.error('ä¿å­˜ç”¨æˆ·å¤±è´¥', e);
                return false;
            }
        }

        async function handleRegister() {
            hideAuthError();
            const n = document.getElementById('uName').value.trim();
            const p = document.getElementById('uPass').value;
            if(!n) { 
                showAuthError("è¯·è¾“å…¥æ˜µç§°"); 
                return; 
            }
            if(p.length < 6) { 
                showAuthError("å¯†ç ä¸èƒ½å°‘äº 6 ä¸ªå­—ç¬¦"); 
                return; 
            }
            await loadUsers();
            const existingUser = users.find(u => u.username === n);
            if (existingUser) {
                showAuthError("âŒ ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•æˆ–ä½¿ç”¨å…¶ä»–æ˜µç§°");
                return;
            }
            const newUserStatus = reviewMode ? 'pending' : 'approved';
            userStatus[n] = newUserStatus;
            users.push({
                username: n,
                password: p,
                createdAt: new Date().toISOString()
            });
            userBadges[n] = 'æ™®é€šç”¨æˆ·';
            const success = await saveUsers(users);
            if (success) {
                if (reviewMode) {
                    showAuthError("âœ… æ³¨å†ŒæˆåŠŸï¼è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼Œæœªé€šè¿‡å®¡æ ¸çš„è´¦å·å°†è¢«è‡ªåŠ¨åˆ é™¤");
                } else {
                    showAuthError("âœ… æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•");
                }
                document.getElementById('uPass').value = '';
            } else {
                showAuthError("âŒ æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        async function handleLogin() {
            hideAuthError();
            const n = document.getElementById('uName').value.trim();
            const p = document.getElementById('uPass').value;
            if(!n) { 
                showAuthError("è¯·è¾“å…¥æ˜µç§°"); 
                return; 
            }
            if(p.length < 6) { 
                showAuthError("å¯†ç ä¸èƒ½å°‘äº 6 ä¸ªå­—ç¬¦"); 
                return; 
            }
            await loadUsers();
            const user = users.find(u => u.username === n);
            if (!user) {
                showAuthError("âŒ æœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œ");
                return;
            }
            if (user.password !== p) {
                showAuthError("âŒ å¯†ç é”™è¯¯");
                return;
            }
            if (!canUserLogin(n)) {
                const status = userStatus[n];
                if (status === 'pending') {
                    showAuthError("â³ æ‚¨çš„è´¦å·æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜é€šè¿‡");
                } else {
                    showAuthError("âŒ è´¦å·çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç™»å½•");
                }
                return;
            }
            currentUser = n; 
            localStorage.setItem('sister_user', n); 
            updateUserUI();
            updateSignatureOwner();
            hideAuthError();
            showAuthError("âœ… ç™»å½•æˆåŠŸï¼");
            await loadData();
            setTimeout(hideAuthError, 3000);
        }

        function updateSignatureOwner() {
            const ownerSpan = document.getElementById('signatureOwner');
            if (currentUser) {
                ownerSpan.innerText = currentUser + ' çš„ç­¾å';
                ownerSpan.style.backgroundColor = 'rgba(242, 166, 116, 0.15)';
            } else {
                ownerSpan.innerText = 'æœªç™»å½•';
                ownerSpan.style.backgroundColor = '#f0f0f0';
            }
        }

        async function updateCloud(newData) {
            document.getElementById('status').innerText = "åŒæ­¥ä¸­...";
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}`, { 
                    method: 'PUT', 
                    headers: { "Content-Type": "application/json", "X-Master-Key": CONFIG.KEY }, 
                    body: JSON.stringify(newData) 
                });
                await loadData();
            } catch (e) { 
                showAuthError("âŒ åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å¯èƒ½è¿‡å¤§");
                setTimeout(hideAuthError, 3000);
            }
        }

        async function loadData() {
            const icon = document.getElementById('refreshIcon'); icon.classList.add('rotating');
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest?v=${Date.now()}`, { headers: { "X-Master-Key": CONFIG.KEY }});
                const d = await res.json(); 
                
                if (d.record.effect) {
                    effectSettings = d.record.effect;
                    document.documentElement.style.setProperty('--effect-color', effectSettings.color);
                    document.documentElement.style.setProperty('--effect-size', effectSettings.size + 'px');
                }
                
                if (d.record.reviewMode !== undefined) {
                    reviewMode = d.record.reviewMode;
                    const toggle = document.getElementById('reviewModeToggle');
                    if (toggle) {
                        toggle.checked = reviewMode;
                        const badge = document.getElementById('reviewModeBadge');
                        badge.innerText = reviewMode ? 'å¼€å¯' : 'å…³é—­';
                        badge.style.background = reviewMode ? '#4caf50' : '#ff9800';
                    }
                }
                
                // åŠ è½½å…è®¸åˆ é™¤ä»–äººåŠ¨æ€è®¾ç½®
                if (d.record.allowDeleteOthers !== undefined) {
                    allowDeleteOthers = d.record.allowDeleteOthers;
                    const toggle = document.getElementById('deleteOthersToggle');
                    if (toggle) {
                        toggle.checked = allowDeleteOthers;
                        const badge = document.getElementById('deleteOthersBadge');
                        badge.innerText = allowDeleteOthers ? 'å¼€å¯' : 'å…³é—­';
                        badge.style.background = allowDeleteOthers ? '#ff4d4d' : '#999';
                    }
                }
                
                if (d.record.userBadges) {
                    userBadges = d.record.userBadges;
                }
                
                if (d.record.userStatus) {
                    userStatus = d.record.userStatus;
                }
                
                if (d.record.signature) {
                    window.signatureData = d.record.signature;
                    if (typeof d.record.signature === 'object') {
                        currentSignature = d.record.signature.content || "âœ¨ è¿™ä¸ªäººå¾ˆæ‡’ï¼Œè¿˜æ²¡æœ‰ç­¾å~";
                        signatureOwner = d.record.signature.owner || null;
                    } else {
                        currentSignature = d.record.signature;
                        signatureOwner = null;
                    }
                } else {
                    currentSignature = "âœ¨ è¿™ä¸ªäººå¾ˆæ‡’ï¼Œè¿˜æ²¡æœ‰ç­¾å~";
                    signatureOwner = null;
                }
                
                notes = d.record.notes || [];
                applyStyles(d.record.settings); 
                render(notes);
                
                if (d.record.users) {
                    users = d.record.users;
                }
                
                // æ›´æ–°ç”¨æˆ·ç®¡ç†è®¡æ•°
                if (document.getElementById('identityList').classList.contains('expanded')) {
                    const filteredCount = currentSearchTerm ? 
                        users.filter(u => u.username.toLowerCase().includes(currentSearchTerm)).length : 
                        users.length;
                    document.getElementById('userCount').innerText = filteredCount;
                } else {
                    document.getElementById('userCount').innerText = users.length;
                }
                
                // æ›´æ–°æˆ‘çš„åŠ¨æ€å†å²
                updateUserHistorySection();
                
                document.getElementById('signatureDisplay').innerText = currentSignature;
                document.getElementById('signatureInput').value = currentSignature;
                
                updateSignatureOwner();
                document.getElementById('status').innerText = "âœ¨ ç©ºé—´å·²åˆ·æ–°";
                
                // æ•°æ®åŠ è½½å®Œæˆåæ˜¾ç¤ºæ¬¢è¿æ ‡è¯­
                showWelcomeBanner();
            } catch (e) { }
            setTimeout(() => icon.classList.remove('rotating'), 500);
        }

        // æˆ‘çš„åŠ¨æ€å†å²ç›¸å…³å‡½æ•°
        function updateUserHistorySection() {
            const section = document.getElementById('historySection');
            if (currentUser) {
                section.style.display = 'block';
                renderUserHistory();
            } else {
                section.style.display = 'none';
            }
        }

        function toggleUserHistory() {
            const container = document.getElementById('historyListContainer');
            const arrow = document.getElementById('historyArrow');
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                arrow.classList.remove('expanded');
            } else {
                container.classList.add('expanded');
                arrow.classList.add('expanded');
                // æ¯æ¬¡å±•å¼€æ—¶é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
                renderUserHistory();
            }
        }

        function filterUserHistory() {
            const input = document.getElementById('historySearchInput');
            userHistorySearchTerm = input.value.toLowerCase().trim();
            renderUserHistory();
        }

        function renderUserHistory() {
            const listContainer = document.getElementById('userHistoryList');
            const countSpan = document.getElementById('userHistoryCount');
            if (!currentUser) {
                listContainer.innerHTML = '<div class="history-empty">è¯·å…ˆç™»å½•</div>';
                countSpan.innerText = '0';
                return;
            }
            // è¿‡æ»¤å½“å‰ç”¨æˆ·çš„åŠ¨æ€
            let userNotes = notes.filter(note => note.author === currentUser);
            // æŒ‰æ—¶é—´å€’åº
            userNotes.sort((a, b) => new Date(b.time) - new Date(a.time));
            // åº”ç”¨æœç´¢è¿‡æ»¤
            if (userHistorySearchTerm) {
                userNotes = userNotes.filter(note => 
                    note.content.toLowerCase().includes(userHistorySearchTerm)
                );
            }
            countSpan.innerText = userNotes.length;
            if (userNotes.length === 0) {
                listContainer.innerHTML = '<div class="history-empty">æš‚æ— åŠ¨æ€</div>';
                return;
            }
            let html = '';
            userNotes.forEach(note => {
                // ç®€å•æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
                let preview = note.content.length > 30 ? note.content.substring(0, 30) + '...' : note.content;
                let imageHtml = '';
                if (note.images && note.images.length > 0) {
                    imageHtml = `<img src="${note.images[0]}" class="history-item-image" onclick="showImageViewer('${note.images[0]}')">`;
                }
                html += `
                    <div class="history-item">
                        <div class="history-item-content">${preview}</div>
                        <div class="history-item-time">${note.time}</div>
                        ${imageHtml}
                    </div>
                `;
            });
            listContainer.innerHTML = html;
        }

        function applyStyles(s) {
            if(!s) s = DEFAULT_S;
            const root = document.documentElement;
            root.style.setProperty('--main', s.theme);
            root.style.setProperty('--bg', s.bgCol);
            root.style.setProperty('--radius', s.radius + 'px');
            document.body.style.backgroundImage = s.bgImg ? `url(${s.bgImg})` : 'none';
            document.getElementById('verDisplay').innerText = s.currentVer;
            document.getElementById('noticeText').innerText = s.notice;
            document.getElementById('historyBox').innerHTML = (s.history || []).reverse().map(h => `<div style="font-size:11px; margin-bottom:5px; color:#666"><b>${h.ver}</b>: ${h.text}</div>`).join('');
        }

        async function deletePost(noteIdx) {
            if (!currentUser) {
                showAuthError("è¯·å…ˆç™»å½•");
                return;
            }
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                let notesData = data.record.notes || [];
                if (!notesData[noteIdx]) {
                    showAuthError("åŠ¨æ€ä¸å­˜åœ¨");
                    return;
                }
                const post = notesData[noteIdx];
                // å…è®¸åˆ é™¤ä»–äººåŠ¨æ€æ—¶è·³è¿‡ä½œè€…æ£€æŸ¥
                if (!allowDeleteOthers && post.author !== currentUser) {
                    showAuthError("åªèƒ½åˆ é™¤è‡ªå·±çš„åŠ¨æ€");
                    return;
                }
                notesData.splice(noteIdx, 1);
                await updateCloud({ ...data.record, notes: notesData });
                showAuthError("âœ… åŠ¨æ€å·²åˆ é™¤");
                setTimeout(hideAuthError, 2000);
            } catch (e) {
                showAuthError("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        function render(notesData) {
            const list = document.getElementById('msgList');
            // æœªç™»å½•ç”¨æˆ·æ— æ³•æŸ¥çœ‹ä»»ä½•åŠ¨æ€
            if (!currentUser) {
                list.innerHTML = '<div class="card" style="text-align:center; color:#999; padding:20px;">ğŸ”’ è¯·å…ˆç™»å½•æŸ¥çœ‹åŠ¨æ€</div>';
                return;
            }
            list.innerHTML = '';
            [...notesData].map((n, i) => ({...n, rIdx: i})).reverse().forEach(note => {
                const div = document.createElement('div'); div.className = 'card';
                // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®çš„æ¡ä»¶ï¼šå·²ç™»å½• ä¸” (å…è®¸åˆ é™¤ä»–äºº æˆ– æ˜¯è‡ªå·±çš„åŠ¨æ€)
                const canDeletePost = currentUser && (allowDeleteOthers || note.author === currentUser);
                const authorBadge = getUserBadge(note.author);
                let imagesHtml = '';
                if (note.images && note.images.length > 0) {
                    imagesHtml = '<div class="post-images">';
                    note.images.forEach(img => {
                        imagesHtml += `<img src="${img}" class="post-image" onclick="showImageViewer('${img}')" alt="åŠ¨æ€å›¾ç‰‡" oncontextmenu="return true">`;
                    });
                    imagesHtml += '</div>';
                }
                const comms = (note.comments || []).map((c, ci) => {
                    const canDeleteComment = currentUser && c.user === currentUser; // è¯„è®ºåˆ é™¤ä¿æŒåŸé€»è¾‘
                    const commenterBadge = getUserBadge(c.user);
                    return `
                        <div class="comment-item">
                            <div class="comment-content">
                                <span class="comment-author" onclick="showUserProfile('${c.user}')">${c.user}</span>
                                ${commenterBadge !== 'æ™®é€šç”¨æˆ·' ? `<span class="user-badge-display">${commenterBadge}</span>` : ''}: ${c.content}
                            </div>
                            <div class="comment-actions">
                                <span class="comment-like" onclick="handleLike(${note.rIdx}, ${ci})">ğŸ‘ ${c.likes || 0}</span>
                                ${canDeleteComment ? `<span class="comment-delete" onclick="showDeleteConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', 'deleteComment(${note.rIdx}, ${ci})')" title="åˆ é™¤è¯„è®º">ğŸ—‘ï¸</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                div.innerHTML = `
                    <div class="card-header">
                        <div class="card-header-left">
                            <span class="author-name" onclick="showUserProfile('${note.author}')">ğŸ‘¤ ${note.author}</span>
                            ${authorBadge !== 'æ™®é€šç”¨æˆ·' ? `<span class="user-badge-display">${authorBadge}</span>` : ''}
                            <span class="post-time">${note.time}</span>
                        </div>
                        ${canDeletePost ? `<span class="post-delete-btn" onclick="showDeleteConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', 'deletePost(${note.rIdx})')" title="åˆ é™¤åŠ¨æ€">ğŸ—‘ï¸</span>` : ''}
                    </div>
                    <div class="post-text">${note.content}</div>
                    ${imagesHtml}
                    <div class="action-bar">
                        <div class="action-btn" onclick="handleLike(${note.rIdx})">ğŸ‘ ${note.likes || 0}</div>
                        <div class="action-btn" onclick="toggleComments(${note.rIdx})">ğŸ’¬ ${(note.comments || []).length}</div>
                    </div>
                    <div id="comments-${note.rIdx}" style="display:none; margin-top:8px">
                        ${comms}
                        <div class="comment-input-group">
                            <input type="text" id="comment-input-${note.rIdx}" class="comment-input-field" placeholder="å†™è¯„è®º...">
                            <button class="comment-send-btn" onclick="submitComment(${note.rIdx})">å‘</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // æ–°å¢ï¼šè¿‡æ»¤æ¸²æŸ“åŠ¨æ€ï¼ˆç”¨äºæœç´¢ï¼‰
        function renderFiltered(notesData) {
            const list = document.getElementById('msgList');
            if (!currentUser) {
                list.innerHTML = '<div class="card" style="text-align:center; color:#999; padding:20px;">ğŸ”’ è¯·å…ˆç™»å½•æŸ¥çœ‹åŠ¨æ€</div>';
                return;
            }
            list.innerHTML = '';
            [...notesData].map((n, i) => ({...n, rIdx: n.originalIndex})).reverse().forEach(note => {
                const div = document.createElement('div'); div.className = 'card';
                const canDeletePost = currentUser && (allowDeleteOthers || note.author === currentUser);
                const authorBadge = getUserBadge(note.author);
                let imagesHtml = '';
                if (note.images && note.images.length > 0) {
                    imagesHtml = '<div class="post-images">';
                    note.images.forEach(img => {
                        imagesHtml += `<img src="${img}" class="post-image" onclick="showImageViewer('${img}')" alt="åŠ¨æ€å›¾ç‰‡" oncontextmenu="return true">`;
                    });
                    imagesHtml += '</div>';
                }
                const comms = (note.comments || []).map((c, ci) => {
                    const canDeleteComment = currentUser && c.user === currentUser;
                    const commenterBadge = getUserBadge(c.user);
                    return `
                        <div class="comment-item">
                            <div class="comment-content">
                                <span class="comment-author" onclick="showUserProfile('${c.user}')">${c.user}</span>
                                ${commenterBadge !== 'æ™®é€šç”¨æˆ·' ? `<span class="user-badge-display">${commenterBadge}</span>` : ''}: ${c.content}
                            </div>
                            <div class="comment-actions">
                                <span class="comment-like" onclick="handleLike(${note.originalIndex}, ${ci})">ğŸ‘ ${c.likes || 0}</span>
                                ${canDeleteComment ? `<span class="comment-delete" onclick="showDeleteConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ', 'deleteComment(${note.originalIndex}, ${ci})')" title="åˆ é™¤è¯„è®º">ğŸ—‘ï¸</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                div.innerHTML = `
                    <div class="card-header">
                        <div class="card-header-left">
                            <span class="author-name" onclick="showUserProfile('${note.author}')">ğŸ‘¤ ${note.author}</span>
                            ${authorBadge !== 'æ™®é€šç”¨æˆ·' ? `<span class="user-badge-display">${authorBadge}</span>` : ''}
                            <span class="post-time">${note.time}</span>
                        </div>
                        ${canDeletePost ? `<span class="post-delete-btn" onclick="showDeleteConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿ', 'deletePost(${note.originalIndex})')" title="åˆ é™¤åŠ¨æ€">ğŸ—‘ï¸</span>` : ''}
                    </div>
                    <div class="post-text">${note.content}</div>
                    ${imagesHtml}
                    <div class="action-bar">
                        <div class="action-btn" onclick="handleLike(${note.originalIndex})">ğŸ‘ ${note.likes || 0}</div>
                        <div class="action-btn" onclick="toggleComments(${note.originalIndex})">ğŸ’¬ ${(note.comments || []).length}</div>
                    </div>
                    <div id="comments-${note.originalIndex}" style="display:none; margin-top:8px">
                        ${comms}
                        <div class="comment-input-group">
                            <input type="text" id="comment-input-${note.originalIndex}" class="comment-input-field" placeholder="å†™è¯„è®º...">
                            <button class="comment-send-btn" onclick="submitComment(${note.originalIndex})">å‘</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // æ–°å¢ï¼šå¤„ç†åŠ¨æ€æœç´¢
        function filterPosts() {
            const term = document.getElementById('postSearchInput').value.trim().toLowerCase();
            if (!term) {
                render(notes);
                return;
            }
            // ä¿ç•™åŸå§‹ç´¢å¼•ä»¥ä¾¿æ“ä½œ
            const filtered = notes.map((note, idx) => ({...note, originalIndex: idx})).filter(note => note.content.toLowerCase().includes(term));
            renderFiltered(filtered);
        }

        // æ¸…é™¤æœç´¢
        function clearPostSearch() {
            document.getElementById('postSearchInput').value = '';
            render(notes);
        }

        async function deleteComment(noteIdx, commentIdx) {
            if (!currentUser) {
                showAuthError("è¯·å…ˆç™»å½•");
                return;
            }
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                let notesData = data.record.notes || [];
                if (!notesData[noteIdx] || !notesData[noteIdx].comments || !notesData[noteIdx].comments[commentIdx]) {
                    showAuthError("è¯„è®ºä¸å­˜åœ¨");
                    return;
                }
                const comment = notesData[noteIdx].comments[commentIdx];
                if (comment.user !== currentUser) {
                    showAuthError("åªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º");
                    return;
                }
                notesData[noteIdx].comments.splice(commentIdx, 1);
                await updateCloud({ ...data.record, notes: notesData });
                showAuthError("âœ… è¯„è®ºå·²åˆ é™¤");
                setTimeout(hideAuthError, 2000);
            } catch (e) {
                showAuthError("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        function toggleSignatureEdit() {
            if (!currentUser) {
                showAuthError('è¯·å…ˆç™»å½•åå†ç¼–è¾‘ç­¾å');
                return;
            }
            const display = document.getElementById('signatureDisplay');
            const editArea = document.getElementById('signatureEditArea');
            const input = document.getElementById('signatureInput');
            if (editArea.style.display === 'none' || !editArea.style.display) {
                display.style.display = 'none';
                editArea.style.display = 'block';
                input.value = currentSignature;
                input.focus();
            } else {
                display.style.display = 'block';
                editArea.style.display = 'none';
            }
        }

        function cancelSignatureEdit() {
            const display = document.getElementById('signatureDisplay');
            const editArea = document.getElementById('signatureEditArea');
            display.style.display = 'block';
            editArea.style.display = 'none';
        }

        async function saveSignature() {
            if (!currentUser) {
                showAuthError('è¯·å…ˆç™»å½•åå†ä¿å­˜ç­¾å');
                return;
            }
            const newSignature = document.getElementById('signatureInput').value.trim();
            if (!newSignature) {
                showAuthError('ç­¾åä¸èƒ½ä¸ºç©º');
                return;
            }
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { 
                    headers: { "X-Master-Key": CONFIG.KEY }
                });
                const data = await res.json();
                const signatureData = {
                    content: newSignature,
                    owner: currentUser,
                    updatedAt: new Date().toISOString()
                };
                const updatedRecord = {
                    ...data.record,
                    signature: signatureData
                };
                await updateCloud(updatedRecord);
                currentSignature = newSignature;
                signatureOwner = currentUser;
                document.getElementById('signatureDisplay').innerText = newSignature;
                updateSignatureOwner();
                cancelSignatureEdit();
                showAuthError("âœ¨ ç­¾åå·²ä¿å­˜åˆ°äº‘ç«¯");
                setTimeout(hideAuthError, 3000);
            } catch (e) {
                showAuthError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function handleLike(nIdx, cIdx = null) {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); let notesData = data.record.notes || [];
            if (cIdx === null) notesData[nIdx].likes = (notesData[nIdx].likes || 0) + 1;
            else notesData[nIdx].comments[cIdx].likes = (notesData[nIdx].comments[cIdx].likes || 0) + 1;
            await updateCloud({ ...data.record, notes: notesData });
        }
        async function submitComment(idx) {
            if(!currentUser) {
                showAuthError("è¯·å…ˆç™»å½•");
                setTimeout(hideAuthError, 3000);
                return;
            }
            const val = document.getElementById(`comment-input-${idx}`).value.trim(); if(!val) return;
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); let notesData = data.record.notes || [];
            if(!notesData[idx].comments) notesData[idx].comments = [];
            notesData[idx].comments.push({ user: currentUser, content: val, likes: 0 });
            await updateCloud({ ...data.record, notes: notesData });
        }
        async function publish() {
            if(!currentUser) {
                showAuthError("è¯·å…ˆç™»å½•");
                setTimeout(hideAuthError, 3000);
                return;
            }
            const content = document.getElementById('msgInput').value.trim();
            if (!content && selectedImages.length === 0) {
                showAuthError("è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡");
                return;
            }
            showAuthError("æ­£åœ¨å‹ç¼©å›¾ç‰‡...");
            const compressedImages = [];
            for (let img of selectedImages) {
                const compressed = await compressImage(img.file);
                compressedImages.push(compressed);
            }
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); 
            let notesData = data.record.notes || [];
            const newNote = {
                author: currentUser,
                content: content || '',
                time: new Date().toLocaleString('zh-CN'),
                comments: [],
                likes: 0
            };
            if (compressedImages.length > 0) {
                newNote.images = compressedImages;
            }
            notesData.push(newNote);
            await updateCloud({ ...data.record, notes: notesData });
            document.getElementById('msgInput').value = '';
            clearImages();
            showAuthError("âœ… åŠ¨æ€å‘å¸ƒæˆåŠŸ");
            setTimeout(hideAuthError, 2000);
        }
        async function saveSettingsToCloud() {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN}/latest`, { headers: { "X-Master-Key": CONFIG.KEY }});
            const data = await res.json(); const s = data.record.settings || DEFAULT_S;
            const v = document.getElementById('devVer').value; const n = document.getElementById('devNotice').value;
            if(v && n && v !== s.currentVer) { s.history.push({ ver: s.currentVer, text: s.notice }); s.currentVer = v; s.notice = n; }
            const effectColor = document.getElementById('effectColor').value;
            const effectSize = parseInt(document.getElementById('effectSize').value);
            const effectShape = document.querySelector('.shape-option.selected')?.dataset.shape || 'circle';
            const upd = { 
                ...s, 
                theme: document.getElementById('themeColor').value, 
                bgCol: document.getElementById('bgColor').value, 
                bgImg: document.getElementById('bgUrl').value, 
                radius: document.getElementById('radiusRange').value 
            };
            const effectSettings = {
                color: effectColor,
                size: effectSize,
                shape: effectShape
            };
            const signatureData = currentSignature ? {
                content: currentSignature,
                owner: signatureOwner || currentUser || 'unknown',
                updatedAt: new Date().toISOString()
            } : null;
            const reviewModeState = document.getElementById('reviewModeToggle').checked;
            const deleteOthersState = document.getElementById('deleteOthersToggle').checked;
            await updateCloud({ 
                ...data.record, 
                settings: upd, 
                effect: effectSettings,
                signature: signatureData, 
                users: users,
                reviewMode: reviewModeState,
                allowDeleteOthers: deleteOthersState,
                userBadges: userBadges,
                userStatus: userStatus
            }); 
            closeAll();
        }
        function toggleHistory() { const b = document.getElementById('historyBox'); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
        function toggleMenu() { document.getElementById('sidePanel').classList.toggle('open'); document.getElementById('overlay').style.display = 'block'; updateUserUI(); updateSignatureOwner(); }
        function closeAll() { document.getElementById('devModal').style.display = 'none'; document.getElementById('sidePanel').classList.remove('open'); document.getElementById('overlay').style.display = 'none'; document.getElementById('devAuthArea').style.display='none'; }
        function showDevAuth() { document.getElementById('devAuthArea').style.display='block'; }
        function verifyDevPass() { 
            if(document.getElementById('devPassInput').value === CONFIG.DEV_PASS) { 
                document.getElementById('effectColor').value = effectSettings.color;
                document.getElementById('effectSize').value = effectSettings.size;
                document.getElementById('effectSizeVal').innerText = effectSettings.size + 'px';
                document.querySelectorAll('.shape-option').forEach(opt => {
                    if (opt.dataset.shape === effectSettings.shape) {
                        opt.classList.add('selected');
                    } else {
                        opt.classList.remove('selected');
                    }
                });
                const reviewToggle = document.getElementById('reviewModeToggle');
                reviewToggle.checked = reviewMode;
                const reviewBadge = document.getElementById('reviewModeBadge');
                reviewBadge.innerText = reviewMode ? 'å¼€å¯' : 'å…³é—­';
                reviewBadge.style.background = reviewMode ? '#4caf50' : '#ff9800';
                
                // è®¾ç½®åˆ é™¤ä»–äººåŠ¨æ€å¼€å…³çŠ¶æ€
                const deleteToggle = document.getElementById('deleteOthersToggle');
                deleteToggle.checked = allowDeleteOthers;
                const deleteBadge = document.getElementById('deleteOthersBadge');
                deleteBadge.innerText = allowDeleteOthers ? 'å¼€å¯' : 'å…³é—­';
                deleteBadge.style.background = allowDeleteOthers ? '#ff4d4d' : '#999';
                
                renderUserList();
                updatePreview();
                document.getElementById('devModal').style.display = 'block'; 
            } else { 
                showAuthError("å£ä»¤é”™è¯¯"); 
            } 
        }
        function logout() { 
            localStorage.removeItem('sister_user'); 
            currentUser = null; 
            updateUserUI(); 
            updateSignatureOwner();
            hideAuthError();
            // æ›´æ–°å†å²åŒºåŸŸæ˜¾ç¤º
            updateUserHistorySection();
            loadData();
            // å¦‚æœå½“å‰åœ¨å·¥å…·ç•Œé¢ï¼Œé€€å‡ºç™»å½•æ—¶è‡ªåŠ¨è¿”å›ä¸»ç•Œé¢
            if (document.getElementById('toolInterface').style.display === 'block') {
                hideToolInterface();
            }
        }
        function updateUserUI() { 
            document.getElementById('userInfo').style.display = currentUser ? 'block' : 'none'; 
            document.getElementById('loginForm').style.display = currentUser ? 'none' : 'block'; 
            if(currentUser) document.getElementById('currUser').innerText = currentUser; 
            // æ§åˆ¶æœç´¢æ¡†æ˜¾ç¤º
            document.getElementById('postSearchContainer').style.display = currentUser ? 'block' : 'none';
            // æ§åˆ¶å·¥å…·æŒ‰é’®æ˜¾ç¤ºï¼ˆä»…ç™»å½•ç”¨æˆ·å¯è§ï¼‰
            const toolBtn = document.getElementById('toolBtn');
            if (toolBtn) {
                toolBtn.style.display = currentUser ? 'inline-flex' : 'none';
            }
        }
        function toggleComments(id) { 
            const el = document.getElementById(`comments-${id}`); 
            if (el) {
                el.style.display = el.style.display === 'block' ? 'none' : 'block'; 
            }
        }
        
        document.getElementById('radiusRange').oninput = function() { 
            document.getElementById('radiusVal').innerText = this.value + 'px'; 
        }
        
        document.getElementById('effectSize').oninput = function() {
            document.getElementById('effectSizeVal').innerText = this.value + 'px';
            updatePreview();
        }
        
        document.getElementById('effectColor').oninput = function() {
            updatePreview();
        }

        window.onload = function() {
            loadData();
            updateSignatureOwner();
            initClickEffect();
            // æ¬¢è¿æ ‡è¯­å·²åœ¨loadDataæˆåŠŸåè°ƒç”¨
            // ç»‘å®šæœç´¢äº‹ä»¶
            document.getElementById('postSearchInput').addEventListener('input', filterPosts);
            document.getElementById('postSearchClear').addEventListener('click', clearPostSearch);
        };
    </script>
</body>
</html>
